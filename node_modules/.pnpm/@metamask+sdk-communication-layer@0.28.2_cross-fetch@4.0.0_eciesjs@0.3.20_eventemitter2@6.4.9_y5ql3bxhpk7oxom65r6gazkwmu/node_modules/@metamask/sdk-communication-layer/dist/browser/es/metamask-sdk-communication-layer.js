import e from"cross-fetch";import{PrivateKey as t,encrypt as n,decrypt as o}from"eciesjs";import{EventEmitter2 as i}from"eventemitter2";import{validate as r,v4 as s}from"uuid";import{io as a}from"socket.io-client";function c(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;var l="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};function u(){throw new Error("setTimeout has not been defined")}function d(){throw new Error("clearTimeout has not been defined")}var h=u,g=d;function m(e){if(h===setTimeout)return setTimeout(e,0);if((h===u||!h)&&setTimeout)return h=setTimeout,setTimeout(e,0);try{return h(e,0)}catch(t){try{return h.call(null,e,0)}catch(t){return h.call(this,e,0)}}}"function"==typeof l.setTimeout&&(h=setTimeout),"function"==typeof l.clearTimeout&&(g=clearTimeout);var f,y=[],v=!1,p=-1;function E(){v&&f&&(v=!1,f.length?y=f.concat(y):p=-1,y.length&&C())}function C(){if(!v){var e=m(E);v=!0;for(var t=y.length;t;){for(f=y,y=[];++p<t;)f&&f[p].run();p=-1,t=y.length}f=null,v=!1,function(e){if(g===clearTimeout)return clearTimeout(e);if((g===d||!g)&&clearTimeout)return g=clearTimeout,clearTimeout(e);try{return g(e)}catch(t){try{return g.call(null,e)}catch(t){return g.call(this,e)}}}(e)}}function S(e,t){this.fun=e,this.array=t}S.prototype.run=function(){this.fun.apply(null,this.array)};function k(){}var _=k,w=k,I=k,x=k,K=k,A=k,b=k;var R=l.performance||{},T=R.now||R.mozNow||R.msNow||R.oNow||R.webkitNow||function(){return(new Date).getTime()};var N=new Date;var O={nextTick:function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];y.push(new S(e,t)),1!==y.length||v||m(C)},title:"browser",browser:!0,env:{},argv:[],version:"",versions:{},on:_,addListener:w,once:I,off:x,removeListener:K,removeAllListeners:A,emit:b,binding:function(e){throw new Error("process.binding is not supported")},cwd:function(){return"/"},chdir:function(e){throw new Error("process.chdir is not supported")},umask:function(){return 0},hrtime:function(e){var t=.001*T.call(R),n=Math.floor(t),o=Math.floor(t%1*1e9);return e&&(n-=e[0],(o-=e[1])<0&&(n--,o+=1e9)),[n,o]},platform:"browser",release:{},config:{},uptime:function(){return(new Date-N)/1e3}};function P(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var L,D,$={exports:{}};function M(){if(D)return L;D=1;var e=1e3,t=60*e,n=60*t,o=24*n,i=7*o,r=365.25*o;function s(e,t,n,o){var i=t>=1.5*n;return Math.round(e/n)+" "+o+(i?"s":"")}return L=function(a,c){c=c||{};var l=typeof a;if("string"===l&&a.length>0)return function(s){if((s=String(s)).length>100)return;var a=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(s);if(!a)return;var c=parseFloat(a[1]);switch((a[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return c*r;case"weeks":case"week":case"w":return c*i;case"days":case"day":case"d":return c*o;case"hours":case"hour":case"hrs":case"hr":case"h":return c*n;case"minutes":case"minute":case"mins":case"min":case"m":return c*t;case"seconds":case"second":case"secs":case"sec":case"s":return c*e;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return c;default:return}}(a);if("number"===l&&isFinite(a))return c.long?function(i){var r=Math.abs(i);if(r>=o)return s(i,r,o,"day");if(r>=n)return s(i,r,n,"hour");if(r>=t)return s(i,r,t,"minute");if(r>=e)return s(i,r,e,"second");return i+" ms"}(a):function(i){var r=Math.abs(i);if(r>=o)return Math.round(i/o)+"d";if(r>=n)return Math.round(i/n)+"h";if(r>=t)return Math.round(i/t)+"m";if(r>=e)return Math.round(i/e)+"s";return i+"ms"}(a);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(a))}}var H=function(e){function t(e){let o,i,r,s=null;function a(...e){if(!a.enabled)return;const n=a,i=Number(new Date),r=i-(o||i);n.diff=r,n.prev=o,n.curr=i,o=i,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let s=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((o,i)=>{if("%%"===o)return"%";s++;const r=t.formatters[i];if("function"==typeof r){const t=e[s];o=r.call(n,t),e.splice(s,1),s--}return o})),t.formatArgs.call(n,e);(n.log||t.log).apply(n,e)}return a.namespace=e,a.useColors=t.useColors(),a.color=t.selectColor(e),a.extend=n,a.destroy=t.destroy,Object.defineProperty(a,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==s?s:(i!==t.namespaces&&(i=t.namespaces,r=t.enabled(e)),r),set:e=>{s=e}}),"function"==typeof t.init&&t.init(a),a}function n(e,n){const o=t(this.namespace+(void 0===n?":":n)+e);return o.log=this.log,o}function o(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},t.disable=function(){const e=[...t.names.map(o),...t.skips.map(o).map((e=>"-"+e))].join(",");return t.enable(""),e},t.enable=function(e){let n;t.save(e),t.namespaces=e,t.names=[],t.skips=[];const o=("string"==typeof e?e:"").split(/[\s,]+/),i=o.length;for(n=0;n<i;n++)o[n]&&("-"===(e=o[n].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.slice(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let n,o;for(n=0,o=t.skips.length;n<o;n++)if(t.skips[n].test(e))return!1;for(n=0,o=t.names.length;n<o;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=M(),t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach((n=>{t[n]=e[n]})),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let n=0;for(let t=0;t<e.length;t++)n=(n<<5)-n+e.charCodeAt(t),n|=0;return t.colors[Math.abs(n)%t.colors.length]},t.enable(t.load()),t};!function(e,t){t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const n="color: "+this.color;t.splice(1,0,n,"color: inherit");let o=0,i=0;t[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&(o++,"%c"===e&&(i=o))})),t.splice(i,0,n)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}!e&&void 0!==O&&"env"in O&&(e=O.env.DEBUG);return e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=H(t);const{formatters:n}=e.exports;n.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}($,$.exports);var U=P($.exports);const Y=U("KeyExchange:Layer"),F=U("SocketService:Layer"),j=U("Ecies:Layer"),z=U("RemoteCommunication:Layer");Y.color="##95c44e",F.color="#f638d7",j.color="#465b9c",z.color="#47a2be";const B={KeyExchange:Y,SocketService:F,Ecies:j,RemoteCommunication:z};let G,V=[],W=[];function J(t){return c(this,void 0,void 0,(function*(){if(!G||!t)return;!function(){const e=W;W=V,V=e}();const n=G.endsWith("/")?`${G}debug`:`${G}/debug`,o=Object.assign({},t);if(delete o.params,t.params)for(const[e,n]of Object.entries(t.params))o[e]=n;const i=JSON.stringify(o);B.RemoteCommunication(`[sendBufferedEvents] Sending ${V.length} analytics events to ${n}`);try{const t=yield e(n,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:i}),o=yield t.text();B.RemoteCommunication(`[sendBufferedEvents] Response: ${o}`),V.length=0}catch(e){console.warn("Error sending analytics",e)}}))}const Z=(e,t)=>c(void 0,void 0,void 0,(function*(){var n;G=t,n=e,W.push(n),J(e).catch((()=>{}))}));var X=[],Q=[],q="undefined"!=typeof Uint8Array?Uint8Array:Array,ee=!1;function te(){ee=!0;for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t=0;t<64;++t)X[t]=e[t],Q[e.charCodeAt(t)]=t;Q["-".charCodeAt(0)]=62,Q["_".charCodeAt(0)]=63}function ne(e,t,n){for(var o,i,r=[],s=t;s<n;s+=3)o=(e[s]<<16)+(e[s+1]<<8)+e[s+2],r.push(X[(i=o)>>18&63]+X[i>>12&63]+X[i>>6&63]+X[63&i]);return r.join("")}function oe(e){var t;ee||te();for(var n=e.length,o=n%3,i="",r=[],s=16383,a=0,c=n-o;a<c;a+=s)r.push(ne(e,a,a+s>c?c:a+s));return 1===o?(t=e[n-1],i+=X[t>>2],i+=X[t<<4&63],i+="=="):2===o&&(t=(e[n-2]<<8)+e[n-1],i+=X[t>>10],i+=X[t>>4&63],i+=X[t<<2&63],i+="="),r.push(i),r.join("")}function ie(e,t,n,o,i){var r,s,a=8*i-o-1,c=(1<<a)-1,l=c>>1,u=-7,d=n?i-1:0,h=n?-1:1,g=e[t+d];for(d+=h,r=g&(1<<-u)-1,g>>=-u,u+=a;u>0;r=256*r+e[t+d],d+=h,u-=8);for(s=r&(1<<-u)-1,r>>=-u,u+=o;u>0;s=256*s+e[t+d],d+=h,u-=8);if(0===r)r=1-l;else{if(r===c)return s?NaN:1/0*(g?-1:1);s+=Math.pow(2,o),r-=l}return(g?-1:1)*s*Math.pow(2,r-o)}function re(e,t,n,o,i,r){var s,a,c,l=8*r-i-1,u=(1<<l)-1,d=u>>1,h=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,g=o?0:r-1,m=o?1:-1,f=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=u):(s=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-s))<1&&(s--,c*=2),(t+=s+d>=1?h/c:h*Math.pow(2,1-d))*c>=2&&(s++,c/=2),s+d>=u?(a=0,s=u):s+d>=1?(a=(t*c-1)*Math.pow(2,i),s+=d):(a=t*Math.pow(2,d-1)*Math.pow(2,i),s=0));i>=8;e[n+g]=255&a,g+=m,a/=256,i-=8);for(s=s<<i|a,l+=i;l>0;e[n+g]=255&s,g+=m,s/=256,l-=8);e[n+g-m]|=128*f}var se={}.toString,ae=Array.isArray||function(e){return"[object Array]"==se.call(e)};function ce(){return ue.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function le(e,t){if(ce()<t)throw new RangeError("Invalid typed array length");return ue.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=ue.prototype:(null===e&&(e=new ue(t)),e.length=t),e}function ue(e,t,n){if(!(ue.TYPED_ARRAY_SUPPORT||this instanceof ue))return new ue(e,t,n);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return ge(this,e)}return de(this,e,t,n)}function de(e,t,n,o){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,n,o){if(t.byteLength,n<0||t.byteLength<n)throw new RangeError("'offset' is out of bounds");if(t.byteLength<n+(o||0))throw new RangeError("'length' is out of bounds");t=void 0===n&&void 0===o?new Uint8Array(t):void 0===o?new Uint8Array(t,n):new Uint8Array(t,n,o);ue.TYPED_ARRAY_SUPPORT?(e=t).__proto__=ue.prototype:e=me(e,t);return e}(e,t,n,o):"string"==typeof t?function(e,t,n){"string"==typeof n&&""!==n||(n="utf8");if(!ue.isEncoding(n))throw new TypeError('"encoding" must be a valid string encoding');var o=0|ve(t,n);e=le(e,o);var i=e.write(t,n);i!==o&&(e=e.slice(0,i));return e}(e,t,n):function(e,t){if(ye(t)){var n=0|fe(t.length);return 0===(e=le(e,n)).length||t.copy(e,0,0,n),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(o=t.length)!=o?le(e,0):me(e,t);if("Buffer"===t.type&&ae(t.data))return me(e,t.data)}var o;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function he(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function ge(e,t){if(he(t),e=le(e,t<0?0:0|fe(t)),!ue.TYPED_ARRAY_SUPPORT)for(var n=0;n<t;++n)e[n]=0;return e}function me(e,t){var n=t.length<0?0:0|fe(t.length);e=le(e,n);for(var o=0;o<n;o+=1)e[o]=255&t[o];return e}function fe(e){if(e>=ce())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+ce().toString(16)+" bytes");return 0|e}function ye(e){return!(null==e||!e._isBuffer)}function ve(e,t){if(ye(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var n=e.length;if(0===n)return 0;for(var o=!1;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":case void 0:return ze(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return Be(e).length;default:if(o)return ze(e).length;t=(""+t).toLowerCase(),o=!0}}function pe(e,t,n){var o=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),n<=0)return"";if((n>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return Oe(this,t,n);case"utf8":case"utf-8":return be(this,t,n);case"ascii":return Te(this,t,n);case"latin1":case"binary":return Ne(this,t,n);case"base64":return Ae(this,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Pe(this,t,n);default:if(o)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),o=!0}}function Ee(e,t,n){var o=e[t];e[t]=e[n],e[n]=o}function Ce(e,t,n,o,i){if(0===e.length)return-1;if("string"==typeof n?(o=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,isNaN(n)&&(n=i?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(i)return-1;n=e.length-1}else if(n<0){if(!i)return-1;n=0}if("string"==typeof t&&(t=ue.from(t,o)),ye(t))return 0===t.length?-1:Se(e,t,n,o,i);if("number"==typeof t)return t&=255,ue.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,n):Uint8Array.prototype.lastIndexOf.call(e,t,n):Se(e,[t],n,o,i);throw new TypeError("val must be string, number or Buffer")}function Se(e,t,n,o,i){var r,s=1,a=e.length,c=t.length;if(void 0!==o&&("ucs2"===(o=String(o).toLowerCase())||"ucs-2"===o||"utf16le"===o||"utf-16le"===o)){if(e.length<2||t.length<2)return-1;s=2,a/=2,c/=2,n/=2}function l(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(i){var u=-1;for(r=n;r<a;r++)if(l(e,r)===l(t,-1===u?0:r-u)){if(-1===u&&(u=r),r-u+1===c)return u*s}else-1!==u&&(r-=r-u),u=-1}else for(n+c>a&&(n=a-c),r=n;r>=0;r--){for(var d=!0,h=0;h<c;h++)if(l(e,r+h)!==l(t,h)){d=!1;break}if(d)return r}return-1}function ke(e,t,n,o){n=Number(n)||0;var i=e.length-n;o?(o=Number(o))>i&&(o=i):o=i;var r=t.length;if(r%2!=0)throw new TypeError("Invalid hex string");o>r/2&&(o=r/2);for(var s=0;s<o;++s){var a=parseInt(t.substr(2*s,2),16);if(isNaN(a))return s;e[n+s]=a}return s}function _e(e,t,n,o){return Ge(ze(t,e.length-n),e,n,o)}function we(e,t,n,o){return Ge(function(e){for(var t=[],n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}(t),e,n,o)}function Ie(e,t,n,o){return we(e,t,n,o)}function xe(e,t,n,o){return Ge(Be(t),e,n,o)}function Ke(e,t,n,o){return Ge(function(e,t){for(var n,o,i,r=[],s=0;s<e.length&&!((t-=2)<0);++s)o=(n=e.charCodeAt(s))>>8,i=n%256,r.push(i),r.push(o);return r}(t,e.length-n),e,n,o)}function Ae(e,t,n){return 0===t&&n===e.length?oe(e):oe(e.slice(t,n))}function be(e,t,n){n=Math.min(e.length,n);for(var o=[],i=t;i<n;){var r,s,a,c,l=e[i],u=null,d=l>239?4:l>223?3:l>191?2:1;if(i+d<=n)switch(d){case 1:l<128&&(u=l);break;case 2:128==(192&(r=e[i+1]))&&(c=(31&l)<<6|63&r)>127&&(u=c);break;case 3:r=e[i+1],s=e[i+2],128==(192&r)&&128==(192&s)&&(c=(15&l)<<12|(63&r)<<6|63&s)>2047&&(c<55296||c>57343)&&(u=c);break;case 4:r=e[i+1],s=e[i+2],a=e[i+3],128==(192&r)&&128==(192&s)&&128==(192&a)&&(c=(15&l)<<18|(63&r)<<12|(63&s)<<6|63&a)>65535&&c<1114112&&(u=c)}null===u?(u=65533,d=1):u>65535&&(u-=65536,o.push(u>>>10&1023|55296),u=56320|1023&u),o.push(u),i+=d}return function(e){var t=e.length;if(t<=Re)return String.fromCharCode.apply(String,e);var n="",o=0;for(;o<t;)n+=String.fromCharCode.apply(String,e.slice(o,o+=Re));return n}(o)}ue.TYPED_ARRAY_SUPPORT=void 0===l.TYPED_ARRAY_SUPPORT||l.TYPED_ARRAY_SUPPORT,ce(),ue.poolSize=8192,ue._augment=function(e){return e.__proto__=ue.prototype,e},ue.from=function(e,t,n){return de(null,e,t,n)},ue.TYPED_ARRAY_SUPPORT&&(ue.prototype.__proto__=Uint8Array.prototype,ue.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&ue[Symbol.species]),ue.alloc=function(e,t,n){return function(e,t,n,o){return he(t),t<=0?le(e,t):void 0!==n?"string"==typeof o?le(e,t).fill(n,o):le(e,t).fill(n):le(e,t)}(null,e,t,n)},ue.allocUnsafe=function(e){return ge(null,e)},ue.allocUnsafeSlow=function(e){return ge(null,e)},ue.isBuffer=function(e){return null!=e&&(!!e._isBuffer||Ve(e)||function(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&Ve(e.slice(0,0))}(e))},ue.compare=function(e,t){if(!ye(e)||!ye(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var n=e.length,o=t.length,i=0,r=Math.min(n,o);i<r;++i)if(e[i]!==t[i]){n=e[i],o=t[i];break}return n<o?-1:o<n?1:0},ue.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},ue.concat=function(e,t){if(!ae(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return ue.alloc(0);var n;if(void 0===t)for(t=0,n=0;n<e.length;++n)t+=e[n].length;var o=ue.allocUnsafe(t),i=0;for(n=0;n<e.length;++n){var r=e[n];if(!ye(r))throw new TypeError('"list" argument must be an Array of Buffers');r.copy(o,i),i+=r.length}return o},ue.byteLength=ve,ue.prototype._isBuffer=!0,ue.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)Ee(this,t,t+1);return this},ue.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)Ee(this,t,t+3),Ee(this,t+1,t+2);return this},ue.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)Ee(this,t,t+7),Ee(this,t+1,t+6),Ee(this,t+2,t+5),Ee(this,t+3,t+4);return this},ue.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?be(this,0,e):pe.apply(this,arguments)},ue.prototype.equals=function(e){if(!ye(e))throw new TypeError("Argument must be a Buffer");return this===e||0===ue.compare(this,e)},ue.prototype.inspect=function(){var e="";return this.length>0&&(e=this.toString("hex",0,50).match(/.{2}/g).join(" "),this.length>50&&(e+=" ... ")),"<Buffer "+e+">"},ue.prototype.compare=function(e,t,n,o,i){if(!ye(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===n&&(n=e?e.length:0),void 0===o&&(o=0),void 0===i&&(i=this.length),t<0||n>e.length||o<0||i>this.length)throw new RangeError("out of range index");if(o>=i&&t>=n)return 0;if(o>=i)return-1;if(t>=n)return 1;if(this===e)return 0;for(var r=(i>>>=0)-(o>>>=0),s=(n>>>=0)-(t>>>=0),a=Math.min(r,s),c=this.slice(o,i),l=e.slice(t,n),u=0;u<a;++u)if(c[u]!==l[u]){r=c[u],s=l[u];break}return r<s?-1:s<r?1:0},ue.prototype.includes=function(e,t,n){return-1!==this.indexOf(e,t,n)},ue.prototype.indexOf=function(e,t,n){return Ce(this,e,t,n,!0)},ue.prototype.lastIndexOf=function(e,t,n){return Ce(this,e,t,n,!1)},ue.prototype.write=function(e,t,n,o){if(void 0===t)o="utf8",n=this.length,t=0;else if(void 0===n&&"string"==typeof t)o=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(n)?(n|=0,void 0===o&&(o="utf8")):(o=n,n=void 0)}var i=this.length-t;if((void 0===n||n>i)&&(n=i),e.length>0&&(n<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");o||(o="utf8");for(var r=!1;;)switch(o){case"hex":return ke(this,e,t,n);case"utf8":case"utf-8":return _e(this,e,t,n);case"ascii":return we(this,e,t,n);case"latin1":case"binary":return Ie(this,e,t,n);case"base64":return xe(this,e,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Ke(this,e,t,n);default:if(r)throw new TypeError("Unknown encoding: "+o);o=(""+o).toLowerCase(),r=!0}},ue.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var Re=4096;function Te(e,t,n){var o="";n=Math.min(e.length,n);for(var i=t;i<n;++i)o+=String.fromCharCode(127&e[i]);return o}function Ne(e,t,n){var o="";n=Math.min(e.length,n);for(var i=t;i<n;++i)o+=String.fromCharCode(e[i]);return o}function Oe(e,t,n){var o=e.length;(!t||t<0)&&(t=0),(!n||n<0||n>o)&&(n=o);for(var i="",r=t;r<n;++r)i+=je(e[r]);return i}function Pe(e,t,n){for(var o=e.slice(t,n),i="",r=0;r<o.length;r+=2)i+=String.fromCharCode(o[r]+256*o[r+1]);return i}function Le(e,t,n){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>n)throw new RangeError("Trying to access beyond buffer length")}function De(e,t,n,o,i,r){if(!ye(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<r)throw new RangeError('"value" argument is out of bounds');if(n+o>e.length)throw new RangeError("Index out of range")}function $e(e,t,n,o){t<0&&(t=65535+t+1);for(var i=0,r=Math.min(e.length-n,2);i<r;++i)e[n+i]=(t&255<<8*(o?i:1-i))>>>8*(o?i:1-i)}function Me(e,t,n,o){t<0&&(t=4294967295+t+1);for(var i=0,r=Math.min(e.length-n,4);i<r;++i)e[n+i]=t>>>8*(o?i:3-i)&255}function He(e,t,n,o,i,r){if(n+o>e.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function Ue(e,t,n,o,i){return i||He(e,0,n,4),re(e,t,n,o,23,4),n+4}function Ye(e,t,n,o,i){return i||He(e,0,n,8),re(e,t,n,o,52,8),n+8}ue.prototype.slice=function(e,t){var n,o=this.length;if((e=~~e)<0?(e+=o)<0&&(e=0):e>o&&(e=o),(t=void 0===t?o:~~t)<0?(t+=o)<0&&(t=0):t>o&&(t=o),t<e&&(t=e),ue.TYPED_ARRAY_SUPPORT)(n=this.subarray(e,t)).__proto__=ue.prototype;else{var i=t-e;n=new ue(i,void 0);for(var r=0;r<i;++r)n[r]=this[r+e]}return n},ue.prototype.readUIntLE=function(e,t,n){e|=0,t|=0,n||Le(e,t,this.length);for(var o=this[e],i=1,r=0;++r<t&&(i*=256);)o+=this[e+r]*i;return o},ue.prototype.readUIntBE=function(e,t,n){e|=0,t|=0,n||Le(e,t,this.length);for(var o=this[e+--t],i=1;t>0&&(i*=256);)o+=this[e+--t]*i;return o},ue.prototype.readUInt8=function(e,t){return t||Le(e,1,this.length),this[e]},ue.prototype.readUInt16LE=function(e,t){return t||Le(e,2,this.length),this[e]|this[e+1]<<8},ue.prototype.readUInt16BE=function(e,t){return t||Le(e,2,this.length),this[e]<<8|this[e+1]},ue.prototype.readUInt32LE=function(e,t){return t||Le(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},ue.prototype.readUInt32BE=function(e,t){return t||Le(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},ue.prototype.readIntLE=function(e,t,n){e|=0,t|=0,n||Le(e,t,this.length);for(var o=this[e],i=1,r=0;++r<t&&(i*=256);)o+=this[e+r]*i;return o>=(i*=128)&&(o-=Math.pow(2,8*t)),o},ue.prototype.readIntBE=function(e,t,n){e|=0,t|=0,n||Le(e,t,this.length);for(var o=t,i=1,r=this[e+--o];o>0&&(i*=256);)r+=this[e+--o]*i;return r>=(i*=128)&&(r-=Math.pow(2,8*t)),r},ue.prototype.readInt8=function(e,t){return t||Le(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},ue.prototype.readInt16LE=function(e,t){t||Le(e,2,this.length);var n=this[e]|this[e+1]<<8;return 32768&n?4294901760|n:n},ue.prototype.readInt16BE=function(e,t){t||Le(e,2,this.length);var n=this[e+1]|this[e]<<8;return 32768&n?4294901760|n:n},ue.prototype.readInt32LE=function(e,t){return t||Le(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},ue.prototype.readInt32BE=function(e,t){return t||Le(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},ue.prototype.readFloatLE=function(e,t){return t||Le(e,4,this.length),ie(this,e,!0,23,4)},ue.prototype.readFloatBE=function(e,t){return t||Le(e,4,this.length),ie(this,e,!1,23,4)},ue.prototype.readDoubleLE=function(e,t){return t||Le(e,8,this.length),ie(this,e,!0,52,8)},ue.prototype.readDoubleBE=function(e,t){return t||Le(e,8,this.length),ie(this,e,!1,52,8)},ue.prototype.writeUIntLE=function(e,t,n,o){(e=+e,t|=0,n|=0,o)||De(this,e,t,n,Math.pow(2,8*n)-1,0);var i=1,r=0;for(this[t]=255&e;++r<n&&(i*=256);)this[t+r]=e/i&255;return t+n},ue.prototype.writeUIntBE=function(e,t,n,o){(e=+e,t|=0,n|=0,o)||De(this,e,t,n,Math.pow(2,8*n)-1,0);var i=n-1,r=1;for(this[t+i]=255&e;--i>=0&&(r*=256);)this[t+i]=e/r&255;return t+n},ue.prototype.writeUInt8=function(e,t,n){return e=+e,t|=0,n||De(this,e,t,1,255,0),ue.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},ue.prototype.writeUInt16LE=function(e,t,n){return e=+e,t|=0,n||De(this,e,t,2,65535,0),ue.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):$e(this,e,t,!0),t+2},ue.prototype.writeUInt16BE=function(e,t,n){return e=+e,t|=0,n||De(this,e,t,2,65535,0),ue.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):$e(this,e,t,!1),t+2},ue.prototype.writeUInt32LE=function(e,t,n){return e=+e,t|=0,n||De(this,e,t,4,4294967295,0),ue.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):Me(this,e,t,!0),t+4},ue.prototype.writeUInt32BE=function(e,t,n){return e=+e,t|=0,n||De(this,e,t,4,4294967295,0),ue.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):Me(this,e,t,!1),t+4},ue.prototype.writeIntLE=function(e,t,n,o){if(e=+e,t|=0,!o){var i=Math.pow(2,8*n-1);De(this,e,t,n,i-1,-i)}var r=0,s=1,a=0;for(this[t]=255&e;++r<n&&(s*=256);)e<0&&0===a&&0!==this[t+r-1]&&(a=1),this[t+r]=(e/s>>0)-a&255;return t+n},ue.prototype.writeIntBE=function(e,t,n,o){if(e=+e,t|=0,!o){var i=Math.pow(2,8*n-1);De(this,e,t,n,i-1,-i)}var r=n-1,s=1,a=0;for(this[t+r]=255&e;--r>=0&&(s*=256);)e<0&&0===a&&0!==this[t+r+1]&&(a=1),this[t+r]=(e/s>>0)-a&255;return t+n},ue.prototype.writeInt8=function(e,t,n){return e=+e,t|=0,n||De(this,e,t,1,127,-128),ue.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},ue.prototype.writeInt16LE=function(e,t,n){return e=+e,t|=0,n||De(this,e,t,2,32767,-32768),ue.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):$e(this,e,t,!0),t+2},ue.prototype.writeInt16BE=function(e,t,n){return e=+e,t|=0,n||De(this,e,t,2,32767,-32768),ue.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):$e(this,e,t,!1),t+2},ue.prototype.writeInt32LE=function(e,t,n){return e=+e,t|=0,n||De(this,e,t,4,2147483647,-2147483648),ue.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):Me(this,e,t,!0),t+4},ue.prototype.writeInt32BE=function(e,t,n){return e=+e,t|=0,n||De(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),ue.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):Me(this,e,t,!1),t+4},ue.prototype.writeFloatLE=function(e,t,n){return Ue(this,e,t,!0,n)},ue.prototype.writeFloatBE=function(e,t,n){return Ue(this,e,t,!1,n)},ue.prototype.writeDoubleLE=function(e,t,n){return Ye(this,e,t,!0,n)},ue.prototype.writeDoubleBE=function(e,t,n){return Ye(this,e,t,!1,n)},ue.prototype.copy=function(e,t,n,o){if(n||(n=0),o||0===o||(o=this.length),t>=e.length&&(t=e.length),t||(t=0),o>0&&o<n&&(o=n),o===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("sourceStart out of bounds");if(o<0)throw new RangeError("sourceEnd out of bounds");o>this.length&&(o=this.length),e.length-t<o-n&&(o=e.length-t+n);var i,r=o-n;if(this===e&&n<t&&t<o)for(i=r-1;i>=0;--i)e[i+t]=this[i+n];else if(r<1e3||!ue.TYPED_ARRAY_SUPPORT)for(i=0;i<r;++i)e[i+t]=this[i+n];else Uint8Array.prototype.set.call(e,this.subarray(n,n+r),t);return r},ue.prototype.fill=function(e,t,n,o){if("string"==typeof e){if("string"==typeof t?(o=t,t=0,n=this.length):"string"==typeof n&&(o=n,n=this.length),1===e.length){var i=e.charCodeAt(0);i<256&&(e=i)}if(void 0!==o&&"string"!=typeof o)throw new TypeError("encoding must be a string");if("string"==typeof o&&!ue.isEncoding(o))throw new TypeError("Unknown encoding: "+o)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<n)throw new RangeError("Out of range index");if(n<=t)return this;var r;if(t>>>=0,n=void 0===n?this.length:n>>>0,e||(e=0),"number"==typeof e)for(r=t;r<n;++r)this[r]=e;else{var s=ye(e)?e:ze(new ue(e,o).toString()),a=s.length;for(r=0;r<n-t;++r)this[r+t]=s[r%a]}return this};var Fe=/[^+\/0-9A-Za-z-_]/g;function je(e){return e<16?"0"+e.toString(16):e.toString(16)}function ze(e,t){var n;t=t||1/0;for(var o=e.length,i=null,r=[],s=0;s<o;++s){if((n=e.charCodeAt(s))>55295&&n<57344){if(!i){if(n>56319){(t-=3)>-1&&r.push(239,191,189);continue}if(s+1===o){(t-=3)>-1&&r.push(239,191,189);continue}i=n;continue}if(n<56320){(t-=3)>-1&&r.push(239,191,189),i=n;continue}n=65536+(i-55296<<10|n-56320)}else i&&(t-=3)>-1&&r.push(239,191,189);if(i=null,n<128){if((t-=1)<0)break;r.push(n)}else if(n<2048){if((t-=2)<0)break;r.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;r.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;r.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return r}function Be(e){return function(e){var t,n,o,i,r,s;ee||te();var a=e.length;if(a%4>0)throw new Error("Invalid string. Length must be a multiple of 4");r="="===e[a-2]?2:"="===e[a-1]?1:0,s=new q(3*a/4-r),o=r>0?a-4:a;var c=0;for(t=0,n=0;t<o;t+=4,n+=3)i=Q[e.charCodeAt(t)]<<18|Q[e.charCodeAt(t+1)]<<12|Q[e.charCodeAt(t+2)]<<6|Q[e.charCodeAt(t+3)],s[c++]=i>>16&255,s[c++]=i>>8&255,s[c++]=255&i;return 2===r?(i=Q[e.charCodeAt(t)]<<2|Q[e.charCodeAt(t+1)]>>4,s[c++]=255&i):1===r&&(i=Q[e.charCodeAt(t)]<<10|Q[e.charCodeAt(t+1)]<<4|Q[e.charCodeAt(t+2)]>>2,s[c++]=i>>8&255,s[c++]=255&i),s}(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(Fe,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function Ge(e,t,n,o){for(var i=0;i<o&&!(i+n>=t.length||i>=e.length);++i)t[i+n]=e[i];return i}function Ve(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}class We{constructor(e){this.enabled=!0,(null==e?void 0:e.debug)&&U.enable("Ecies:Layer"),(null==e?void 0:e.privateKey)?this.ecies=t.fromHex(e.privateKey):this.ecies=new t,B.Ecies("[ECIES constructor()] initialized secret: ",this.ecies.toHex()),B.Ecies("[ECIES constructor()] initialized public: ",this.ecies.publicKey.toHex()),B.Ecies("[ECIES constructor()] init with",this)}generateECIES(){this.ecies=new t}getPublicKey(){return this.ecies.publicKey.toHex()}encrypt(e,t){let o=e;if(this.enabled)try{B.Ecies("[ECIES: encrypt()] using otherPublicKey",t);const i=ue.from(e),r=n(t,i);o=ue.from(r).toString("base64")}catch(n){throw B.Ecies("[ECIES: encrypt()] error encrypt:",n),B.Ecies("[ECIES: encrypt()] private: ",this.ecies.toHex()),B.Ecies("[ECIES: encrypt()] data: ",e),B.Ecies("[ECIES: encrypt()] otherkey: ",t),n}return o}decrypt(e){let t=e;if(this.enabled)try{B.Ecies("[ECIES: decrypt()] using privateKey",this.ecies.toHex());const n=ue.from(e.toString(),"base64");t=o(this.ecies.toHex(),n).toString()}catch(t){throw B.Ecies("[ECIES: decrypt()] error decrypt",t),B.Ecies("[ECIES: decrypt()] private: ",this.ecies.toHex()),B.Ecies("[ECIES: decrypt()] encryptedData: ",e),t}return t}getKeyInfo(){return{private:this.ecies.toHex(),public:this.ecies.publicKey.toHex()}}toString(){B.Ecies("[ECIES: toString()]",this.getKeyInfo())}}var Je={name:"@metamask/sdk-communication-layer",version:"0.28.2",description:"",homepage:"https://github.com/MetaMask/metamask-sdk#readme",bugs:{url:"https://github.com/MetaMask/metamask-sdk/issues"},repository:{type:"git",url:"https://github.com/MetaMask/metamask-sdk.git",directory:"packages/sdk-communication-layer"},main:"dist/node/cjs/metamask-sdk-communication-layer.js",unpkg:"dist/browser/umd/metamask-sdk-communication-layer.js",module:"dist/node/es/metamask-sdk-communication-layer.js",browser:"dist/browser/es/metamask-sdk-communication-layer.js","react-native":"dist/react-native/es/metamask-sdk-communication-layer.js",types:"dist/browser/es/src/index.d.ts",files:["/dist"],scripts:{build:"rimraf dist && rollup -c --bundleConfigAsCjs","build:tsc":"tsc","build:dev":"rimraf dist && NODE_ENV=dev rollup -c --bundleConfigAsCjs","build:post-tsc":"echo 'N/A'","build:pre-tsc":"echo 'N/A'",size:"size-limit",clean:"rimraf ./dist",lint:"yarn lint:eslint && yarn lint:misc --check","lint:changelog":"../../scripts/validate-changelog.sh @metamask/sdk-communication-layer","lint:eslint":"eslint . --cache --ext js,ts","lint:fix":"yarn lint:eslint --fix && yarn lint:misc --write","lint:misc":"prettier '**/*.json' '**/*.md' '!CHANGELOG.md' --ignore-path ../../.gitignore","publish:preview":"yarn npm publish --tag preview",prepack:"../../scripts/prepack.sh",reset:"yarn clean && rimraf ./node_modules/",test:'jest --testPathIgnorePatterns "/e2e/"',"test:e2e":'jest --testPathPattern "/e2e/"',"test:coverage":"jest --coverage","test:ci":'jest --coverage --passWithNoTests --setupFilesAfterEnv ./jest-preload.js --testPathIgnorePatterns "/e2e/"',"test:dev":"jest",watch:"rollup -c --bundleConfigAsCjs -w"},dependencies:{bufferutil:"^4.0.8","date-fns":"^2.29.3",debug:"^4.3.4","utf-8-validate":"^5.0.2",uuid:"^8.3.2"},devDependencies:{"@jest/globals":"^29.3.1","@lavamoat/allow-scripts":"^2.3.1","@metamask/auto-changelog":"3.1.0","@metamask/eslint-config":"^6.0.0","@metamask/eslint-config-nodejs":"^6.0.0","@metamask/eslint-config-typescript":"^6.0.0","@rollup/plugin-commonjs":"^25.0.0","@rollup/plugin-json":"^6.0.0","@rollup/plugin-node-resolve":"^15.0.2","@rollup/plugin-terser":"^0.4.1","@size-limit/preset-big-lib":"^11.0.2","@types/jest":"^29.2.4","@types/node":"^20.1.3","@types/uuid":"^9.0.0","@typescript-eslint/eslint-plugin":"^4.26.0","@typescript-eslint/parser":"^4.26.0","cross-fetch":"^4.0.0",eciesjs:"^0.3.16",eslint:"^7.30.0","eslint-config-prettier":"^8.3.0","eslint-plugin-import":"^2.23.4","eslint-plugin-jest":"^24.4.0","eslint-plugin-jsdoc":"^36.1.0","eslint-plugin-node":"^11.1.0","eslint-plugin-prettier":"^3.4.0",eventemitter2:"^6.4.7",jest:"^29.3.1",prettier:"^2.3.0",rimraf:"^3.0.2",rollup:"^3.21.7","rollup-plugin-jscc":"^2.0.0","rollup-plugin-natives":"^0.7.5","rollup-plugin-node-builtins":"^2.1.2","rollup-plugin-node-globals":"^1.4.0","rollup-plugin-peer-deps-external":"^2.2.4","rollup-plugin-sizes":"^1.0.6","rollup-plugin-typescript2":"^0.31.2","rollup-plugin-visualizer":"^5.9.2","size-limit":"^11.0.2","socket.io-client":"^4.5.1","stream-browserify":"^3.0.0","ts-jest":"^29.0.3","ts-node":"^10.9.1",typescript:"^4.3.2"},peerDependencies:{"cross-fetch":"^4.0.0",eciesjs:"^0.3.16",eventemitter2:"^6.4.7","readable-stream":"^3.6.2","socket.io-client":"^4.5.1"},publishConfig:{access:"public",registry:"https://registry.npmjs.org/"},lavamoat:{allowScripts:{"@lavamoat/preinstall-always-fail":!1,canvas:!0,"eciesjs>secp256k1":!1,"socket.io-client>engine.io-client>ws>bufferutil":!1,"socket.io-client>engine.io-client>ws>utf-8-validate":!1,bufferutil:!1,"utf-8-validate":!1}}};const Ze="https://metamask-sdk.api.cx.metamask.io/",Xe=["websocket"],Qe=6048e5,qe={METAMASK_GETPROVIDERSTATE:"metamask_getProviderState",ETH_REQUESTACCOUNTS:"eth_requestAccounts"};function et(e){const{context:t}=e;B.RemoteCommunication(`[RemoteCommunication: clean()] context=${t}`),e.channelConfig=void 0,e.ready=!1,e.originatorConnectStarted=!1}var tt,nt,ot,it,rt;!function(e){e.DISCONNECTED="disconnected",e.WAITING="waiting",e.TIMEOUT="timeout",e.LINKED="linked",e.PAUSED="paused",e.TERMINATED="terminated"}(tt||(tt={})),function(e){e.KEY_INFO="key_info",e.SERVICE_STATUS="service_status",e.PROVIDER_UPDATE="provider_update",e.RPC_UPDATE="rpc_update",e.KEYS_EXCHANGED="keys_exchanged",e.JOIN_CHANNEL="join_channel",e.PUBLIC_KEY="public_key",e.CHANNEL_CREATED="channel_created",e.CLIENTS_CONNECTED="clients_connected",e.CLIENTS_DISCONNECTED="clients_disconnected",e.CLIENTS_WAITING="clients_waiting",e.CLIENTS_READY="clients_ready",e.WALLET_INIT="wallet_init",e.CHANNEL_PERSISTENCE="channel_persistence",e.MESSAGE_ACK="ack",e.SOCKET_DISCONNECTED="socket_disconnected",e.SOCKET_RECONNECT="socket_reconnect",e.OTP="otp",e.SDK_RPC_CALL="sdk_rpc_call",e.AUTHORIZED="authorized",e.CONNECTION_STATUS="connection_status",e.MESSAGE="message",e.TERMINATE="terminate"}(nt||(nt={})),function(e){e.KEY_EXCHANGE="key_exchange"}(ot||(ot={})),function(e){e.KEY_HANDSHAKE_START="key_handshake_start",e.KEY_HANDSHAKE_CHECK="key_handshake_check",e.KEY_HANDSHAKE_SYN="key_handshake_SYN",e.KEY_HANDSHAKE_SYNACK="key_handshake_SYNACK",e.KEY_HANDSHAKE_ACK="key_handshake_ACK",e.KEY_HANDSHAKE_WALLET="key_handshake_wallet",e.KEY_HANDSHAKE_NONE="none"}(it||(it={}));class st extends i{constructor({communicationLayer:e,otherPublicKey:t,context:n,ecies:o,logging:i}){super(),this.keysExchanged=!1,this.step=it.KEY_HANDSHAKE_NONE,this.debug=!1,this.context=n,this.communicationLayer=e,(null==o?void 0:o.privateKey)&&t&&(B.KeyExchange(`[KeyExchange: constructor()] otherPubKey=${t} set keysExchanged to true!`,o),this.keysExchanged=!0),this.myECIES=new We(Object.assign(Object.assign({},o),{debug:null==i?void 0:i.eciesLayer})),this.communicationLayer.state.eciesInstance=this.myECIES,this.myPublicKey=this.myECIES.getPublicKey(),this.debug=!0===(null==i?void 0:i.keyExchangeLayer),t&&this.setOtherPublicKey(t),this.communicationLayer.on(ot.KEY_EXCHANGE,this.onKeyExchangeMessage.bind(this))}onKeyExchangeMessage(e){const{relayPersistence:t}=this.communicationLayer.remote.state;if(B.KeyExchange(`[KeyExchange: onKeyExchangeMessage()] context=${this.context} keysExchanged=${this.keysExchanged} relayPersistence=${t}`,e),t)return void B.KeyExchange("[KeyExchange: onKeyExchangeMessage()] Ignoring key exchange message because relay persistence is activated");const{message:n}=e;this.keysExchanged&&B.KeyExchange(`[KeyExchange: onKeyExchangeMessage()] context=${this.context} received handshake while already exchanged. step=${this.step} otherPubKey=${this.otherPublicKey}`),this.emit(nt.KEY_INFO,n.type),n.type===it.KEY_HANDSHAKE_SYN?(this.checkStep([it.KEY_HANDSHAKE_NONE,it.KEY_HANDSHAKE_ACK]),B.KeyExchange("[KeyExchange: onKeyExchangeMessage()] KEY_HANDSHAKE_SYN",n),n.pubkey&&this.setOtherPublicKey(n.pubkey),this.communicationLayer.sendMessage({type:it.KEY_HANDSHAKE_SYNACK,pubkey:this.myPublicKey}),this.setStep(it.KEY_HANDSHAKE_ACK)):n.type===it.KEY_HANDSHAKE_SYNACK?(this.checkStep([it.KEY_HANDSHAKE_SYNACK,it.KEY_HANDSHAKE_ACK,it.KEY_HANDSHAKE_NONE]),B.KeyExchange("[KeyExchange: onKeyExchangeMessage()] KEY_HANDSHAKE_SYNACK"),n.pubkey&&this.setOtherPublicKey(n.pubkey),this.communicationLayer.sendMessage({type:it.KEY_HANDSHAKE_ACK}),this.keysExchanged=!0,this.setStep(it.KEY_HANDSHAKE_ACK),this.emit(nt.KEYS_EXCHANGED)):n.type===it.KEY_HANDSHAKE_ACK&&(B.KeyExchange("[KeyExchange: onKeyExchangeMessage()] KEY_HANDSHAKE_ACK set keysExchanged to true!"),this.checkStep([it.KEY_HANDSHAKE_ACK,it.KEY_HANDSHAKE_NONE]),this.keysExchanged=!0,this.setStep(it.KEY_HANDSHAKE_ACK),this.emit(nt.KEYS_EXCHANGED))}resetKeys(e){this.clean(),this.myECIES=new We(e)}clean(){B.KeyExchange(`[KeyExchange: clean()] context=${this.context} reset handshake state`),this.setStep(it.KEY_HANDSHAKE_NONE),this.emit(nt.KEY_INFO,this.step),this.keysExchanged=!1}start({isOriginator:e,force:t}){const{relayPersistence:n,protocolVersion:o}=this.communicationLayer.remote.state,i=o>=2;if(n)return B.KeyExchange("[KeyExchange: start()] Ignoring key exchange message because relay persistence is activated"),void console.log(`[KeyExchange: start()] relayPersistence=${n}`);B.KeyExchange(`[KeyExchange: start()] context=${this.context} protocolVersion=${o} isOriginator=${e} step=${this.step} force=${t} relayPersistence=${n} keysExchanged=${this.keysExchanged}`),e?!(this.keysExchanged||this.step!==it.KEY_HANDSHAKE_NONE&&this.step!==it.KEY_HANDSHAKE_SYNACK)||t?(B.KeyExchange(`[KeyExchange: start()] context=${this.context} -- start key exchange (force=${t}) -- step=${this.step}`,this.step),this.clean(),this.setStep(it.KEY_HANDSHAKE_SYNACK),this.communicationLayer.sendMessage({type:it.KEY_HANDSHAKE_SYN,pubkey:this.myPublicKey,v:2})):B.KeyExchange(`[KeyExchange: start()] context=${this.context} -- key exchange already ${this.keysExchanged?"done":"in progress"} -- aborted.`,this.step):this.keysExchanged&&!0!==t?B.KeyExchange("[KeyExchange: start()] don't send KEY_HANDSHAKE_START -- exchange already done."):i?this.communicationLayer.sendMessage({type:it.KEY_HANDSHAKE_SYNACK,pubkey:this.myPublicKey,v:2}):(this.communicationLayer.sendMessage({type:it.KEY_HANDSHAKE_START}),this.clean())}setStep(e){this.step=e,this.emit(nt.KEY_INFO,e)}checkStep(e){e.length>0&&-1===e.indexOf(this.step.toString())&&console.warn(`[KeyExchange: checkStep()]  Wrong Step "${this.step}" not within ${e}`)}setRelayPersistence({localKey:e,otherKey:t}){this.otherPublicKey=t,this.myECIES=new We({privateKey:e,debug:this.debug}),this.keysExchanged=!0}setKeysExchanged(e){this.keysExchanged=e}areKeysExchanged(){return this.keysExchanged}getMyPublicKey(){return this.myPublicKey}getOtherPublicKey(){return this.otherPublicKey}setOtherPublicKey(e){B.KeyExchange("[KeyExchange: setOtherPubKey()]",e),this.otherPublicKey=e}encryptMessage(e){if(!this.otherPublicKey)throw new Error("encryptMessage: Keys not exchanged - missing otherPubKey");return this.myECIES.encrypt(e,this.otherPublicKey)}decryptMessage(e){if(!this.otherPublicKey)throw new Error("decryptMessage: Keys not exchanged - missing otherPubKey");return this.myECIES.decrypt(e)}getKeyInfo(){return{ecies:Object.assign(Object.assign({},this.myECIES.getKeyInfo()),{otherPubKey:this.otherPublicKey}),step:this.step,keysExchanged:this.areKeysExchanged()}}toString(){const e={keyInfo:this.getKeyInfo(),keysExchanged:this.keysExchanged,step:this.step};return JSON.stringify(e)}}!function(e){e.TERMINATE="terminate",e.ANSWER="answer",e.OFFER="offer",e.CANDIDATE="candidate",e.JSONRPC="jsonrpc",e.WALLET_INFO="wallet_info",e.WALLET_INIT="wallet_init",e.ORIGINATOR_INFO="originator_info",e.PAUSE="pause",e.OTP="otp",e.AUTHORIZED="authorized",e.PING="ping",e.READY="ready"}(rt||(rt={}));const at=(e,t,n)=>c(void 0,void 0,void 0,(function*(){var o,i,r,s,a;const{remote:c,state:l}=e,{channelId:u,isOriginator:d}=l;if("error_terminated"===t)return B.SocketService(`handleJoinChannelResults: Channel ${u} terminated`),void e.emit(nt.TERMINATE);if(!n)return void B.SocketService(`handleJoinChannelResults: No result for channel ${u}`);const{persistence:h,walletKey:g}=n;if(B.SocketService(`handleJoinChannelResults: Channel ${u} persistence=${h} walletKey=${g}`),g&&!(null===(o=c.state.channelConfig)||void 0===o?void 0:o.otherKey)){e.getKeyExchange().setOtherPublicKey(g),null===(i=e.state.keyExchange)||void 0===i||i.setKeysExchanged(!0),c.state.ready=!0,c.state.authorized=!0,c.emit(nt.AUTHORIZED);const{communicationLayer:t,storageManager:n}=c.state,o=Object.assign(Object.assign({},c.state.channelConfig),{channelId:null!==(r=c.state.channelId)&&void 0!==r?r:"",validUntil:Date.now()+Qe,localKey:null==t?void 0:t.getKeyInfo().ecies.private,otherKey:g});e.sendMessage({type:it.KEY_HANDSHAKE_ACK}),null===(s=e.state.socket)||void 0===s||s.emit(rt.PING,{id:u,clientType:d?"dapp":"wallet",context:"on_channel_reconnect",message:""}),yield null==n?void 0:n.persistChannelConfig(o),c.emitServiceStatusEvent(),c.setConnectionStatus(tt.LINKED)}h&&(e.emit(nt.CHANNEL_PERSISTENCE),null===(a=e.state.keyExchange)||void 0===a||a.setKeysExchanged(!0),c.state.ready=!0,c.state.authorized=!0,c.emit(nt.AUTHORIZED))}));const ct=e=>new Promise((t=>{setTimeout(t,e)})),lt=(e,t,n=200)=>c(void 0,void 0,void 0,(function*(){let o;const i=Date.now();let r=!1;for(;!r;){if(r=Date.now()-i>3e5,o=t[e],void 0!==o.elapsedTime)return o;yield ct(n)}throw new Error(`RPC ${e} timed out`)})),ut=({rpcId:e,instance:t})=>c(void 0,void 0,void 0,(function*(){for(;t.state.lastRpcId===e||void 0===t.state.lastRpcId;)yield ct(200);return t.state.lastRpcId})),dt=e=>c(void 0,void 0,void 0,(function*(){const{state:t}=e,{socket:n,channelId:o,context:i,isOriginator:r,isReconnecting:s}=t;if(s)return B.SocketService("[SocketService: reconnectSocket()] Reconnection already in progress, skipping",e),!1;if(!n)return B.SocketService("[SocketService: reconnectSocket()] socket is not defined",e),!1;if(!o)return!1;const{connected:a}=n;t.isReconnecting=!0,t.reconnectionAttempts=0,B.SocketService(`[SocketService: reconnectSocket()] connected=${a} trying to reconnect after socketio disconnection`,e);try{for(;t.reconnectionAttempts<3;){if(B.SocketService(`[SocketService: reconnectSocket()] Attempt ${t.reconnectionAttempts+1} of 3`,e),yield ct(200),n.connected)return B.SocketService("Socket already connected --- ping to retrieve messages"),n.emit(rt.PING,{id:o,clientType:r?"dapp":"wallet",context:"on_channel_config",message:""}),!0;t.resumed=!0,n.connect(),e.emit(nt.SOCKET_RECONNECT);try{if(yield new Promise(((t,s)=>{n.emit(nt.JOIN_CHANNEL,{channelId:o,context:`${i}connect_again`,clientType:r?"dapp":"wallet"},((n,o)=>c(void 0,void 0,void 0,(function*(){try{yield at(e,n,o),t()}catch(e){s(e)}}))))})),yield ct(100),n.connected)return B.SocketService(`Reconnection successful on attempt ${t.reconnectionAttempts+1}`),!0}catch(e){B.SocketService(`Error during reconnection attempt ${t.reconnectionAttempts+1}:`,e)}t.reconnectionAttempts+=1,t.reconnectionAttempts<3&&(yield ct(200))}return B.SocketService("Failed to reconnect after 3 attempts"),!1}finally{t.isReconnecting=!1,t.reconnectionAttempts=0}}));var ht;!function(e){e.REQUEST="sdk_connect_request_started",e.REQUEST_MOBILE="sdk_connect_request_started_mobile",e.RECONNECT="sdk_reconnect_request_started",e.CONNECTED="sdk_connection_established",e.CONNECTED_MOBILE="sdk_connection_established_mobile",e.AUTHORIZED="sdk_connection_authorized",e.REJECTED="sdk_connection_rejected",e.TERMINATED="sdk_connection_terminated",e.DISCONNECTED="sdk_disconnected",e.SDK_USE_EXTENSION="sdk_use_extension",e.SDK_RPC_REQUEST="sdk_rpc_request",e.SDK_RPC_REQUEST_RECEIVED="sdk_rpc_request_received",e.SDK_RPC_REQUEST_DONE="sdk_rpc_request_done",e.SDK_EXTENSION_UTILIZED="sdk_extension_utilized",e.SDK_USE_INAPP_BROWSER="sdk_use_inapp_browser"}(ht||(ht={}));const gt="SDK_CONNECTION_ISSUE";var mt;!function(e){e.RPC_CHECK="rpcCheck",e.SKIPPED_RPC="skippedRpc"}(mt||(mt={}));const ft=["eth_sendTransaction","eth_signTypedData","eth_signTransaction","personal_sign","wallet_requestPermissions","wallet_switchEthereumChain","eth_signTypedData_v3","eth_signTypedData_v4","metamask_connectSign","metamask_connectWith","metamask_batch"].map((e=>e.toLowerCase()));function yt(e,t){var n,o,i,r;if(!e.state.channelId)throw B.SocketService("handleSendMessage: no channelId - Create a channel first"),new Error("Create a channel first");B.SocketService(`[SocketService: handleSendMessage()] context=${e.state.context} areKeysExchanged=${null===(n=e.state.keyExchange)||void 0===n?void 0:n.areKeysExchanged()}`,t);(null===(o=null==t?void 0:t.type)||void 0===o?void 0:o.startsWith("key_handshake"))?function(e,t){var n;B.SocketService(`[SocketService: handleKeyHandshake()] context=${e.state.context}`,t),null===(n=e.state.socket)||void 0===n||n.emit(nt.MESSAGE,{id:e.state.channelId,context:e.state.context,clientType:e.state.isOriginator?"dapp":"wallet",message:t})}(e,t):(!function(e,t){var n;if(!(null===(n=e.state.keyExchange)||void 0===n?void 0:n.areKeysExchanged())&&!e.remote.state.relayPersistence)throw B.SocketService(`[SocketService: validateKeyExchange()] context=${e.state.context} ERROR keys not exchanged`,t),console.error("[SocketService: validateKeyExchange()] ERROR keys not exchanged",t),new Error("Keys not exchanged BBB")}(e,t),function(e,t){var n;const o=null!==(n=null==t?void 0:t.method)&&void 0!==n?n:"",i=null==t?void 0:t.id;e.state.isOriginator&&i&&(e.state.rpcMethodTracker[i]={id:i,timestamp:Date.now(),method:o},e.emit(nt.RPC_UPDATE,e.state.rpcMethodTracker[i]))}(e,t),function(e,t){var n,o;const i=null===(n=e.state.keyExchange)||void 0===n?void 0:n.encryptMessage(JSON.stringify(t)),r={id:e.state.channelId,context:e.state.context,clientType:e.state.isOriginator?"dapp":"wallet",message:i,plaintext:e.state.hasPlaintext?JSON.stringify(t):void 0};B.SocketService(`[SocketService: encryptAndSendMessage()] context=${e.state.context}`,r),t.type===rt.TERMINATE&&(e.state.manualDisconnect=!0),null===(o=e.state.socket)||void 0===o||o.emit(nt.MESSAGE,r)}(e,t),e.remote.state.analytics&&e.remote.state.isOriginator&&t.method&&ft.includes(t.method.toLowerCase())&&Z({id:null!==(i=e.remote.state.channelId)&&void 0!==i?i:"",event:ht.SDK_RPC_REQUEST,sdkVersion:e.remote.state.sdkVersion,commLayerVersion:Je.version,walletVersion:null===(r=e.remote.state.walletInfo)||void 0===r?void 0:r.version,params:{method:t.method,from:"mobile"}},e.remote.state.communicationServerUrl).catch((e=>{console.error("Cannot send analytics",e)})),function(e,t){var n;return c(this,void 0,void 0,(function*(){const o=null==t?void 0:t.id,i=null!==(n=null==t?void 0:t.method)&&void 0!==n?n:"";if(e.state.isOriginator&&o)try{const n=lt(o,e.state.rpcMethodTracker,200).then((e=>({type:mt.RPC_CHECK,result:e}))),r=(()=>c(this,void 0,void 0,(function*(){const t=yield ut({instance:e,rpcId:o}),n=yield lt(t,e.state.rpcMethodTracker,200);return{type:mt.SKIPPED_RPC,result:n}})))(),s=yield Promise.race([n,r]);if(s.type===mt.RPC_CHECK){const e=s.result;B.SocketService(`[SocketService:handleRpcReplies()] id=${t.id} ${i} ( ${e.elapsedTime} ms)`,e.result)}else{if(s.type!==mt.SKIPPED_RPC)throw new Error(`Error handling RPC replies for ${o}`);{const{result:t}=s;console.warn(`[SocketService handleRpcReplies()] RPC METHOD HAS BEEN SKIPPED rpcid=${o} method=${i}`,t);const n=Object.assign(Object.assign({},e.state.rpcMethodTracker[o]),{error:new Error(gt)});e.emit(nt.RPC_UPDATE,n);const r={data:Object.assign(Object.assign({},n),{jsonrpc:"2.0"}),name:"metamask-provider"};e.emit(nt.MESSAGE,{message:r})}}}catch(e){throw console.warn(`[SocketService handleRpcReplies()] Error rpcId=${t.id} ${i}`,e),e}}))}(e,t).catch((e=>{console.warn("Error handleRpcReplies",e)})))}const vt=[{event:"clients_connected",handler:function(e,t){return n=>c(this,void 0,void 0,(function*(){var n,o,i,r,s,a,c,l,u,d,h;const g=null!==(o=null===(n=e.remote.state.channelConfig)||void 0===n?void 0:n.relayPersistence)&&void 0!==o&&o;if(B.SocketService(`[SocketService: handleClientsConnected()] context=${e.state.context} on 'clients_connected-${t}' relayPersistence=${g} resumed=${e.state.resumed}  clientsPaused=${e.state.clientsPaused} keysExchanged=${null===(i=e.state.keyExchange)||void 0===i?void 0:i.areKeysExchanged()} isOriginator=${e.state.isOriginator}`),e.emit(nt.CLIENTS_CONNECTED,{isOriginator:e.state.isOriginator,keysExchanged:null===(r=e.state.keyExchange)||void 0===r?void 0:r.areKeysExchanged(),context:e.state.context}),e.state.resumed)e.state.isOriginator||(B.SocketService(`[SocketService: handleClientsConnected()] context=${e.state.context} 'clients_connected' / keysExchanged=${null===(s=e.state.keyExchange)||void 0===s?void 0:s.areKeysExchanged()} -- backward compatibility`),null===(a=e.state.keyExchange)||void 0===a||a.start({isOriginator:null!==(c=e.state.isOriginator)&&void 0!==c&&c})),e.state.resumed=!1;else if(e.state.clientsPaused)B.SocketService("[SocketService: handleClientsConnected()] 'clients_connected' skip sending originatorInfo on pause");else if(!e.state.isOriginator){const t=!g;B.SocketService(`[SocketService: handleClientsConnected()] context=${e.state.context} on 'clients_connected' / keysExchanged=${null===(l=e.state.keyExchange)||void 0===l?void 0:l.areKeysExchanged()} -- force=${t} -- backward compatibility`),B.SocketService(`[SocketService: handleClientsConnected()] context=${e.state.context} on 'clients_connected' / keysExchanged=${null===(u=e.state.keyExchange)||void 0===u?void 0:u.areKeysExchanged()} -- force=${t} -- backward compatibility`),null===(d=e.state.keyExchange)||void 0===d||d.start({isOriginator:null!==(h=e.state.isOriginator)&&void 0!==h&&h,force:t})}e.state.clientsConnected=!0,e.state.clientsPaused=!1}))}},{event:"channel_created",handler:function(e,t){return n=>{B.SocketService(`[SocketService: handleChannelCreated()] context=${e.state.context} on 'channel_created-${t}'`,n),e.emit(nt.CHANNEL_CREATED,n)}}},{event:"clients_disconnected",handler:function(e,t){return()=>{var n;e.state.clientsConnected=!1,B.SocketService(`[SocketService: handlesClientsDisconnected()] context=${e.state.context} on 'clients_disconnected-${t}'`),e.remote.state.relayPersistence?B.SocketService(`[SocketService: handlesClientsDisconnected()] context=${e.state.context} on 'clients_disconnected-${t}' - relayPersistence enabled, skipping key exchange cleanup.`):(e.state.isOriginator&&!e.state.clientsPaused&&(null===(n=e.state.keyExchange)||void 0===n||n.clean()),e.emit(nt.CLIENTS_DISCONNECTED,t))}}},{event:"config",handler:function(e,t){return n=>c(this,void 0,void 0,(function*(){var o,i,r;B.SocketService(`[SocketService: handleChannelConfig()] update relayPersistence on 'config-${t}'`,n);const{persistence:s,walletKey:a}=n;e.state.isOriginator&&e.remote.state.channelConfig?(n.walletKey&&!e.remote.state.channelConfig.otherKey&&(B.SocketService(`Setting wallet key ${a}`),e.remote.state.channelConfig.otherKey=a,e.getKeyExchange().setOtherPublicKey(n.walletKey),null===(o=e.state.keyExchange)||void 0===o||o.setKeysExchanged(!0),yield e.remote.sendMessage({type:it.KEY_HANDSHAKE_ACK}),yield e.remote.sendMessage({type:rt.PING}),yield null===(i=e.remote.state.storageManager)||void 0===i?void 0:i.persistChannelConfig(e.remote.state.channelConfig)),!0!==s||e.remote.state.channelConfig.relayPersistence||(B.SocketService(`Setting relay persistence ${s}`),e.remote.state.channelConfig.relayPersistence=s,e.remote.state.relayPersistence=!0,e.remote.emit(nt.CHANNEL_PERSISTENCE),e.remote.state.authorized=!0,e.remote.state.ready=!0,e.remote.emit(nt.AUTHORIZED),yield null===(r=e.remote.state.storageManager)||void 0===r?void 0:r.persistChannelConfig(e.remote.state.channelConfig))):e.state.isOriginator||n.persistence&&(e.remote.state.relayPersistence=!0,e.remote.emit(nt.CHANNEL_PERSISTENCE))}))}},{event:"message",handler:function(e,t){return n=>{var o,i,r,s,a,c,l,u,d,h,g,m,f,y,v,p,E,C;const{id:S,ackId:k,message:_,error:w}=n,I=null!==(o=e.remote.state.relayPersistence)&&void 0!==o&&o;if(B.SocketService(`[SocketService handleMessage()]  relayPersistence=${I}  context=${e.state.context} on 'message' ${t} keysExchanged=${null===(i=e.state.keyExchange)||void 0===i?void 0:i.areKeysExchanged()}`,n),w)throw B.SocketService(`\n      [SocketService handleMessage()] context=${e.state.context}::on 'message' error=${w}`),new Error(w);try{!function(e,t){if(t!==e.channelId)throw e.debug&&console.error(`Wrong id ${t} - should be ${e.channelId}`),new Error("Wrong id")}(e.state,S)}catch(e){return void console.error("ignore message --- wrong id ",_)}const x="string"==typeof _;if(!x&&(null==_?void 0:_.type)===it.KEY_HANDSHAKE_START)return I?void console.warn("[SocketService handleMessage()] Ignoring key exchange message because relay persistence is activated",_):(B.SocketService(`[SocketService handleMessage()] context=${e.state.context}::on 'message' received HANDSHAKE_START isOriginator=${e.state.isOriginator}`,_),void(null===(r=e.state.keyExchange)||void 0===r||r.start({isOriginator:null!==(s=e.state.isOriginator)&&void 0!==s&&s,force:!0})));if(!x&&(null===(a=null==_?void 0:_.type)||void 0===a?void 0:a.startsWith("key_handshake")))return I?void console.warn("[SocketService handleMessage()] Ignoring key exchange message because relay persistence is activated",_):(B.SocketService(`[SocketService handleMessage()] context=${e.state.context}::on 'message' emit KEY_EXCHANGE`,_),void e.emit(ot.KEY_EXCHANGE,{message:_,context:e.state.context}));if(x&&!(null===(c=e.state.keyExchange)||void 0===c?void 0:c.areKeysExchanged())){let t=!1;try{B.SocketService(`[SocketService handleMessage()] context=${e.state.context}::on 'message' trying to decrypt message`),null===(l=e.state.keyExchange)||void 0===l||l.decryptMessage(_),t=!0}catch(t){B.SocketService(`[SocketService handleMessage()] context=${e.state.context}::on 'message' error`,t)}if(!t)return e.state.isOriginator?null===(d=e.state.keyExchange)||void 0===d||d.start({isOriginator:null!==(h=e.state.isOriginator)&&void 0!==h&&h}):e.sendMessage({type:it.KEY_HANDSHAKE_START}),void B.SocketService(`Message ignored because invalid key exchange status. step=${null===(g=e.state.keyExchange)||void 0===g?void 0:g.getKeyInfo().step}`,null===(m=e.state.keyExchange)||void 0===m?void 0:m.getKeyInfo(),_);B.SocketService("Invalid key exchange status detected --- updating it."),null===(u=e.state.keyExchange)||void 0===u||u.setKeysExchanged(!0)}else if(!x&&(null==_?void 0:_.type))return console.warn("[SocketService handleMessage() ::on 'message' received non encrypted unkwown message"),void e.emit(nt.MESSAGE,_);if(!x)return console.warn("[SocketService handleMessage() ::on 'message' received unkwown message",_),void e.emit(nt.MESSAGE,_);const K=null===(f=e.state.keyExchange)||void 0===f?void 0:f.decryptMessage(_),A=JSON.parse(null!=K?K:"{}");if(k&&(null==k?void 0:k.length)>0&&(B.SocketService(`[SocketService handleMessage()] context=${e.state.context}::on 'message' ackid=${k} channelId=${S}`),null===(y=e.state.socket)||void 0===y||y.emit(nt.MESSAGE_ACK,{ackId:k,channelId:S,clientType:e.state.isOriginator?"dapp":"wallet"})),(null==A?void 0:A.type)===rt.PAUSE?e.state.clientsPaused=!0:e.state.clientsPaused=!1,e.state.isOriginator&&A.data){const t=A.data,n=e.state.rpcMethodTracker[t.id];if(n){const o=Date.now()-n.timestamp;B.SocketService(`[SocketService handleMessage()] context=${e.state.context}::on 'message' received answer for id=${t.id} method=${n.method} responseTime=${o}`,A),e.remote.state.analytics&&ft.includes(n.method.toLowerCase())&&Z({id:null!==(v=e.remote.state.channelId)&&void 0!==v?v:"",event:ht.SDK_RPC_REQUEST_DONE,sdkVersion:e.remote.state.sdkVersion,commLayerVersion:Je.version,walletVersion:null===(p=e.remote.state.walletInfo)||void 0===p?void 0:p.version,params:{method:n.method,from:"mobile"}},e.remote.state.communicationServerUrl).catch((e=>{console.error("Cannot send analytics",e)}));const i=Object.assign(Object.assign({},n),{result:t.result,error:t.error?{code:null===(E=t.error)||void 0===E?void 0:E.code,message:null===(C=t.error)||void 0===C?void 0:C.message}:void 0,elapsedTime:o});e.state.rpcMethodTracker[t.id]=i,e.emit(nt.RPC_UPDATE,i)}}e.emit(nt.MESSAGE,{message:A})}}},{event:"clients_waiting_to_join",handler:function(e,t){return n=>{B.SocketService(`[SocketService: handleClientsWaitingToJoin()] context=${e.state.context} on 'clients_waiting_to_join-${t}'`,n),e.emit(nt.CLIENTS_WAITING,n)}}}],pt=[{event:nt.KEY_INFO,handler:function(e){return t=>{B.SocketService("[SocketService: handleKeyInfo()] on 'KEY_INFO'",t),e.emit(nt.KEY_INFO,t)}}},{event:nt.KEYS_EXCHANGED,handler:function(e){return()=>{var t,n,o;B.SocketService(`[SocketService: handleKeysExchanged()] on 'keys_exchanged' keyschanged=${null===(t=e.state.keyExchange)||void 0===t?void 0:t.areKeysExchanged()}`);const{channelConfig:i}=e.remote.state;if(i){const t=e.getKeyExchange().getKeyInfo().ecies;i.localKey=t.private,i.otherKey=t.otherPubKey,e.remote.state.channelConfig=i,null===(n=e.remote.state.storageManager)||void 0===n||n.persistChannelConfig(i).catch((e=>{console.error("Error persisting channel config",e)}))}e.emit(nt.KEYS_EXCHANGED,{keysExchanged:null===(o=e.state.keyExchange)||void 0===o?void 0:o.areKeysExchanged(),isOriginator:e.state.isOriginator});const r={keyInfo:e.getKeyInfo()};e.emit(nt.SERVICE_STATUS,r)}}}];function Et(e,t){B.SocketService(`[SocketService: setupChannelListener()] context=${e.state.context} setting socket listeners for channel ${t}...`);const{socket:n}=e.state,{keyExchange:o}=e.state;n&&e.state.isOriginator&&(e.state.debug&&(null==n||n.io.on("error",(t=>{B.SocketService(`[SocketService: setupChannelListener()] context=${e.state.context} socket event=error`,t)})),null==n||n.io.on("reconnect",(t=>{B.SocketService(`[SocketService: setupChannelListener()] context=${e.state.context} socket event=reconnect`,t),dt(e).catch((e=>{}))})),null==n||n.io.on("reconnect_error",(t=>{B.SocketService(`[SocketService: setupChannelListener()] context=${e.state.context} socket event=reconnect_error`,t)})),null==n||n.io.on("reconnect_failed",(()=>{B.SocketService(`[SocketService: setupChannelListener()] context=${e.state.context} socket event=reconnect_failed`)})),null==n||n.io.on("ping",(()=>{B.SocketService(`[SocketService: setupChannelListener()] context=${e.state.context} socket`)}))),null==n||n.on("disconnect",(t=>(B.SocketService(`[SocketService: setupChannelListener()] on 'disconnect' -- MetaMaskSDK socket disconnected '${t}' begin recovery...`),function(e){return t=>{B.SocketService(`[SocketService: handleDisconnect()] on 'disconnect' manualDisconnect=${e.state.manualDisconnect}`,t),e.state.manualDisconnect||(e.emit(nt.SOCKET_DISCONNECTED),dt(e).catch((e=>{console.error("SocketService::handleDisconnect Error reconnecting socket",e)})))}}(e)(t))))),vt.forEach((({event:o,handler:i})=>{const r=`${o}-${t}`;null==n||n.on(r,i(e,t))})),pt.forEach((({event:t,handler:n})=>{null==o||o.on(t,n(e))})),e.state.setupChannelListeners=!0}class Ct extends i{constructor(e){super(),this.state={clientsConnected:!1,clientsPaused:!1,manualDisconnect:!1,lastRpcId:void 0,rpcMethodTracker:{},hasPlaintext:!1,communicationServerUrl:"",focusListenerAdded:!1,removeFocusListener:void 0,isReconnecting:!1,reconnectionAttempts:0},this.options=e;const{reconnect:t,communicationLayerPreference:n,communicationServerUrl:o,context:i,remote:r,logging:s}=e;this.state.resumed=t,this.state.context=i,this.state.isOriginator=r.state.isOriginator,this.state.communicationLayerPreference=n,this.state.debug=!0===(null==s?void 0:s.serviceLayer),this.remote=r,!0===(null==s?void 0:s.serviceLayer)&&U.enable("SocketService:Layer"),this.state.communicationServerUrl=o,this.state.hasPlaintext=this.state.communicationServerUrl!==Ze&&!0===(null==s?void 0:s.plaintext),B.SocketService(`[SocketService: constructor()] Socket IO url: ${this.state.communicationServerUrl}`),this.initSocket()}initSocket(){var e;const{otherPublicKey:t,ecies:n,logging:o}=this.options,i={autoConnect:!1,transports:Xe,withCredentials:!0},r=this.state.communicationServerUrl;B.SocketService(`[SocketService: initSocket()] Socket IO url: ${r}`),this.state.socket=a(r,i),function(e){if("undefined"!=typeof window&&"undefined"!=typeof document&&(B.SocketService(`[SocketService: setupSocketFocusListener()] hasFocus=${document.hasFocus()}`,e),!e.state.focusListenerAdded)){const t=()=>{B.SocketService("Document has focus --- reconnecting socket"),dt(e).catch((e=>{console.error("setupSocketFocusListeners Error reconnecting socket",e)}))};window.addEventListener("focus",t),e.state.focusListenerAdded=!0,e.state.removeFocusListener=()=>{window.removeEventListener("focus",t),e.state.focusListenerAdded=!1}}}(this);const s={communicationLayer:this,otherPublicKey:t,sendPublicKey:!1,context:null!==(e=this.state.context)&&void 0!==e?e:"",ecies:n,logging:o};this.state.keyExchange=new st(s)}resetKeys(){return e=this,B.SocketService("[SocketService: resetKeys()] Resetting keys."),void(null===(t=e.state.keyExchange)||void 0===t||t.resetKeys());var e,t}createChannel(){return c(this,void 0,void 0,(function*(){return function(e){var t,n,o;return c(this,void 0,void 0,(function*(){if(B.SocketService(`[SocketService: createChannel()] context=${e.state.context}`),e.state.socket||e.initSocket(),null===(t=e.state.socket)||void 0===t?void 0:t.connected)throw console.error("[SocketService: createChannel()] socket already connected"),new Error("socket already connected");null===(n=e.state.socket)||void 0===n||n.connect(),e.state.manualDisconnect=!1,e.state.isOriginator=!0;const i=s();e.state.channelId=i,Et(e,i),yield new Promise(((t,n)=>{var o;null===(o=e.state.socket)||void 0===o||o.emit(nt.JOIN_CHANNEL,{channelId:i,context:`${e.state.context}createChannel`,clientType:"dapp"},((o,i)=>c(this,void 0,void 0,(function*(){try{yield at(e,o,i),t()}catch(e){n(e)}}))))}));const r=null===(o=e.state.keyExchange)||void 0===o?void 0:o.getKeyInfo();return{channelId:i,pubKey:(null==r?void 0:r.ecies.public)||"",privKey:(null==r?void 0:r.ecies.private)||""}}))}(this)}))}connectToChannel({channelId:e,withKeyExchange:t=!1,authorized:n}){return function({options:e,instance:t}){return c(this,void 0,void 0,(function*(){const{channelId:n,authorized:o,withKeyExchange:i}=e,{state:r,remote:s}=t,{isOriginator:a=!1,socket:l,keyExchange:u}=r,{channelConfig:d}=s.state;if(null==l?void 0:l.connected)throw console.error("[SocketService: connectToChannel()] socket already connected"),new Error("socket already connected");if(a&&(null==d?void 0:d.relayPersistence)){const{localKey:e,otherKey:t}=d;e&&t?null==u||u.setRelayPersistence({localKey:e,otherKey:t}):console.warn("Missing keys in relay persistence",d)}return Object.assign(r,{manualDisconnect:!1,withKeyExchange:i,isOriginator:a,channelId:n}),null==l||l.connect(),Et(t,n),!a&&o&&(null==u||u.setKeysExchanged(!0),Object.assign(s.state,{ready:!0,authorized:!0})),new Promise((e=>{var i;const s=null===(i=null==u?void 0:u.getKeyInfo())||void 0===i?void 0:i.ecies.public,d=o&&!a?s:void 0;null==l||l.emit(nt.JOIN_CHANNEL,{channelId:n,context:`${r.context}_connectToChannel`,clientType:a?"dapp":"wallet",publicKey:d},((n,o)=>c(this,void 0,void 0,(function*(){yield at(t,n,o),e()}))))}))}))}({options:{channelId:e,withKeyExchange:t,authorized:n},instance:this})}getKeyInfo(){return this.state.keyExchange.getKeyInfo()}keyCheck(){var e,t;null===(t=(e=this).state.socket)||void 0===t||t.emit(nt.MESSAGE,{id:e.state.channelId,context:e.state.context,message:{type:it.KEY_HANDSHAKE_CHECK,pubkey:e.getKeyInfo().ecies.otherPubKey}})}getKeyExchange(){return this.state.keyExchange}sendMessage(e){return yt(this,e)}ping(){return e=this,B.SocketService(`[SocketService: ping()] context=${e.state.context} originator=${e.state.isOriginator} keysExchanged=${null===(t=e.state.keyExchange)||void 0===t?void 0:t.areKeysExchanged()}`),e.state.isOriginator&&((null===(n=e.state.keyExchange)||void 0===n?void 0:n.areKeysExchanged())?(console.warn(`[SocketService:ping()] context=${e.state.context} sending READY message`),e.sendMessage({type:rt.READY})):(console.warn(`[SocketService: ping()] context=${e.state.context} starting key exchange`),null===(o=e.state.keyExchange)||void 0===o||o.start({isOriginator:null!==(i=e.state.isOriginator)&&void 0!==i&&i}))),void(null===(r=e.state.socket)||void 0===r||r.emit(nt.MESSAGE,{id:e.state.channelId,context:e.state.context,clientType:e.remote.state.isOriginator?"dapp":"wallet",message:{type:rt.PING}}));var e,t,n,o,i,r}pause(){return e=this,B.SocketService(`[SocketService: pause()] context=${e.state.context}`),e.state.manualDisconnect=!0,(null===(t=e.state.keyExchange)||void 0===t?void 0:t.areKeysExchanged())&&e.sendMessage({type:rt.PAUSE}),void(null===(n=e.state.socket)||void 0===n||n.disconnect());var e,t,n}isConnected(){var e;return null===(e=this.state.socket)||void 0===e?void 0:e.connected}resume(){return function(e){const{state:t,remote:n}=e,{socket:o,channelId:i,context:r,keyExchange:s,isOriginator:a}=t,{isOriginator:l}=n.state;if(B.SocketService(`[SocketService: resume()] channelId=${i} context=${r} connected=${null==o?void 0:o.connected} manualDisconnect=${t.manualDisconnect} resumed=${t.resumed} keysExchanged=${null==s?void 0:s.areKeysExchanged()}`),!i)throw B.SocketService("[SocketService: resume()] channelId is not defined"),new Error("ChannelId is not defined");(null==o?void 0:o.connected)?(B.SocketService("[SocketService: resume()] already connected."),o.emit(rt.PING,{id:i,clientType:l?"dapp":"wallet",context:"on_channel_config",message:""}),n.hasRelayPersistence()||(null==s?void 0:s.areKeysExchanged())||(a?e.sendMessage({type:rt.READY}):null==s||s.start({isOriginator:!1}))):(null==o||o.connect(),B.SocketService(`[SocketService: resume()] after connecting socket --\x3e connected=${null==o?void 0:o.connected}`),null==o||o.emit(nt.JOIN_CHANNEL,{channelId:i,context:`${r}_resume`,clientType:l?"dapp":"wallet"},((t,n)=>c(this,void 0,void 0,(function*(){try{yield at(e,t,n)}catch(e){console.warn("Error reconnecting to channel",e)}}))))),t.manualDisconnect=!1,t.resumed=!0}(this)}getRPCMethodTracker(){return this.state.rpcMethodTracker}disconnect(e){return function(e,t){var n,o,i,r,s;B.SocketService(`[SocketService: disconnect()] context=${e.state.context}`,t),(null==t?void 0:t.terminate)&&(null===(o=(n=e.state).removeFocusListener)||void 0===o||o.call(n),e.state.channelId=t.channelId,null===(i=e.state.socket)||void 0===i||i.removeAllListeners(),null===(r=e.state.keyExchange)||void 0===r||r.clean(),e.remote.state.ready=!1,e.state.socket=void 0,e.state.rpcMethodTracker={}),e.state.manualDisconnect=!0,null===(s=e.state.socket)||void 0===s||s.disconnect()}(this,e)}}var St,kt,_t;function wt(e){return()=>c(this,void 0,void 0,(function*(){var t,n,o;const{state:i}=e;if(i.authorized)return;yield(()=>c(this,void 0,void 0,(function*(){for(;!i.walletInfo;)yield ct(500)})))();const r="7.3".localeCompare((null===(t=i.walletInfo)||void 0===t?void 0:t.version)||"");if(B.RemoteCommunication(`[RemoteCommunication: handleAuthorizedEvent()] HACK 'authorized' version=${null===(n=i.walletInfo)||void 0===n?void 0:n.version} compareValue=${r}`),1!==r)return;const s=i.platformType===kt.MobileWeb||i.platformType===kt.ReactNative||i.platformType===kt.MetaMaskMobileWebview;B.RemoteCommunication(`[RemoteCommunication: handleAuthorizedEvent()] HACK 'authorized' platform=${i.platformType} secure=${s} channel=${i.channelId} walletVersion=${null===(o=i.walletInfo)||void 0===o?void 0:o.version}`),s&&(i.authorized=!0,e.emit(nt.AUTHORIZED))}))}function It(e){return t=>{const{state:n}=e;B.RemoteCommunication(`[RemoteCommunication: handleChannelCreatedEvent()] context=${n.context} on 'channel_created' channelId=${t}`),e.emit(nt.CHANNEL_CREATED,t)}}function xt(e,t){return()=>{var n,o,i,r;const{state:s}=e;if(B.RemoteCommunication(`[RemoteCommunication: handleClientsConnectedEvent()] on 'clients_connected' channel=${s.channelId} keysExchanged=${null===(o=null===(n=s.communicationLayer)||void 0===n?void 0:n.getKeyInfo())||void 0===o?void 0:o.keysExchanged}`),s.analytics){const e=s.isOriginator?ht.REQUEST:ht.REQUEST_MOBILE;Z(Object.assign(Object.assign({id:null!==(i=s.channelId)&&void 0!==i?i:"",event:s.reconnection?ht.RECONNECT:e},s.originatorInfo),{commLayer:t,sdkVersion:s.sdkVersion,walletVersion:null===(r=s.walletInfo)||void 0===r?void 0:r.version,commLayerVersion:Je.version}),s.communicationServerUrl).catch((e=>{console.error("Cannot send analytics",e)}))}s.clientsConnected=!0,s.originatorInfoSent=!1,e.emit(nt.CLIENTS_CONNECTED)}}function Kt(e,t){return n=>{var o;const{state:i}=e;B.RemoteCommunication(`[RemoteCommunication: handleClientsDisconnectedEvent()] context=${i.context} on 'clients_disconnected' channelId=${n}`),i.relayPersistence||(i.clientsConnected=!1,i.ready=!1,i.authorized=!1),e.emit(nt.CLIENTS_DISCONNECTED,i.channelId),e.setConnectionStatus(tt.DISCONNECTED),i.analytics&&i.channelId&&Z({id:i.channelId,event:ht.DISCONNECTED,sdkVersion:i.sdkVersion,commLayer:t,commLayerVersion:Je.version,walletVersion:null===(o=i.walletInfo)||void 0===o?void 0:o.version},i.communicationServerUrl).catch((e=>{console.error("Cannot send analytics",e)}))}}function At(e){return t=>{var n;const{state:o}=e;if(B.RemoteCommunication(`[RemoteCommunication: handleClientsWaitingEvent()] context=${o.context} on 'clients_waiting' numberUsers=${t} ready=${o.ready} autoStarted=${o.originatorConnectStarted}`),e.setConnectionStatus(tt.WAITING),e.emit(nt.CLIENTS_WAITING,t),o.originatorConnectStarted){B.RemoteCommunication(`[RemoteCommunication: handleClientsWaitingEvent()] on 'clients_waiting' watch autoStarted=${o.originatorConnectStarted} timeout`,o.autoConnectOptions);const t=(null===(n=o.autoConnectOptions)||void 0===n?void 0:n.timeout)||3e3,i=setTimeout((()=>{B.RemoteCommunication(`[RemoteCommunication: handleClientsWaitingEvent()] setTimeout(${t}) terminate channelConfig`,o.autoConnectOptions),o.originatorConnectStarted=!1,o.ready||e.setConnectionStatus(tt.TIMEOUT),clearTimeout(i)}),t)}}}function bt(e,t){return n=>{var o,i,r,s,a,c,l,u;const{state:d}=e;if(B.RemoteCommunication(`[RemoteCommunication: handleKeysExchangedEvent()] context=${d.context} on commLayer.'keys_exchanged' channel=${d.channelId}`,n),null===(i=null===(o=d.communicationLayer)||void 0===o?void 0:o.getKeyInfo())||void 0===i?void 0:i.keysExchanged){const t=Object.assign(Object.assign({},d.channelConfig),{channelId:null!==(r=d.channelId)&&void 0!==r?r:"",validUntil:(null===(s=d.channelConfig)||void 0===s?void 0:s.validUntil)||Qe,localKey:d.communicationLayer.getKeyInfo().ecies.private,otherKey:d.communicationLayer.getKeyInfo().ecies.otherPubKey});null===(a=d.storageManager)||void 0===a||a.persistChannelConfig(t).catch((e=>{console.error("Error persisting channel config",e)})),e.setConnectionStatus(tt.LINKED)}!function(e,t){var n,o,i,r,s,a,c,l;const{state:u}=e;B.RemoteCommunication(`[RemoteCommunication: setLastActiveDate()] channel=${u.channelId}`,t);const d=Object.assign(Object.assign({},u.channelConfig),{channelId:null!==(n=u.channelId)&&void 0!==n?n:"",validUntil:null!==(i=null===(o=u.channelConfig)||void 0===o?void 0:o.validUntil)&&void 0!==i?i:0,relayPersistence:u.relayPersistence,localKey:null===(s=null===(r=u.communicationLayer)||void 0===r?void 0:r.state.keyExchange)||void 0===s?void 0:s.getKeyInfo().ecies.private,otherKey:null===(c=null===(a=u.communicationLayer)||void 0===a?void 0:a.state.keyExchange)||void 0===c?void 0:c.getKeyInfo().ecies.otherPubKey,lastActive:t.getTime()});null===(l=u.storageManager)||void 0===l||l.persistChannelConfig(d)}(e,new Date),d.analytics&&d.channelId&&Z({id:d.channelId,event:n.isOriginator?ht.CONNECTED:ht.CONNECTED_MOBILE,sdkVersion:d.sdkVersion,commLayer:t,commLayerVersion:Je.version,walletVersion:null===(c=d.walletInfo)||void 0===c?void 0:c.version},d.communicationServerUrl).catch((e=>{console.error("Cannot send analytics",e)})),d.isOriginator=n.isOriginator,n.isOriginator||(null===(l=d.communicationLayer)||void 0===l||l.sendMessage({type:rt.READY}),d.ready=!0,d.paused=!1),n.isOriginator&&!d.originatorInfoSent&&(null===(u=d.communicationLayer)||void 0===u||u.sendMessage({type:rt.ORIGINATOR_INFO,originatorInfo:d.originatorInfo,originator:d.originatorInfo}),d.originatorInfoSent=!0)}}function Rt(e,t){const{state:n}=t;if(B.RemoteCommunication(`[RemoteCommunication: onCommunicationLayerMessage()] context=${n.context} on 'message' typeof=${typeof e}`,e),t.state.ready=!0,n.isOriginator||e.type!==rt.ORIGINATOR_INFO)if(n.isOriginator&&e.type===rt.WALLET_INFO)!function(e,t){const{state:n}=e;n.walletInfo=t.walletInfo,n.paused=!1}(t,e);else{if(n.isOriginator&&e.type===rt.WALLET_INIT)(function(e,t){var n,o,i;return c(this,void 0,void 0,(function*(){const{state:r}=e;if(r.isOriginator){const r=t.data||{};if("object"==typeof r&&"accounts"in r&&"chainId"in r&&"walletKey"in r)try{const{channelConfig:t}=e.state;if(B.RemoteCommunication("WALLET_INIT: channelConfig",JSON.stringify(t,null,2)),t){const s=r.accounts,a=r.chainId,c=r.walletKey;yield null===(n=e.state.storageManager)||void 0===n?void 0:n.persistChannelConfig(Object.assign(Object.assign({},t),{otherKey:c,relayPersistence:!0})),yield null===(o=e.state.storageManager)||void 0===o?void 0:o.persistAccounts(s),yield null===(i=e.state.storageManager)||void 0===i?void 0:i.persistChainId(a)}e.emit(nt.WALLET_INIT,{accounts:r.accounts,chainId:r.chainId})}catch(e){console.error('RemoteCommunication::on "wallet_init" -- error',e)}else console.error('RemoteCommunication::on "wallet_init" -- invalid data format',r)}}))})(t,e).catch((e=>{B.RemoteCommunication(`[RemoteCommunication: onCommunicationLayerMessage()] error=${e}`)}));else if(e.type===rt.TERMINATE)!function(e){const{state:t}=e;t.isOriginator&&(Dt({options:{terminate:!0,sendMessage:!1},instance:e}),console.debug(),e.emit(nt.TERMINATE))}(t);else if(e.type===rt.PAUSE)!function(e){const{state:t}=e;t.paused=!0,e.setConnectionStatus(tt.PAUSED)}(t);else if(e.type===rt.READY&&n.isOriginator)!function(e){const{state:t}=e;e.setConnectionStatus(tt.LINKED);const n=t.paused;t.paused=!1,e.emit(nt.CLIENTS_READY,{isOriginator:t.isOriginator,walletInfo:t.walletInfo}),n&&(t.authorized=!0,e.emit(nt.AUTHORIZED))}(t);else{if(e.type===rt.OTP&&n.isOriginator)return void function(e,t){var n;const{state:o}=e;e.emit(nt.OTP,t.otpAnswer),1==="6.6".localeCompare((null===(n=o.walletInfo)||void 0===n?void 0:n.version)||"")&&(console.warn("RemoteCommunication::on 'otp' -- backward compatibility <6.6 -- triger eth_requestAccounts"),e.emit(nt.SDK_RPC_CALL,{method:qe.ETH_REQUESTACCOUNTS,params:[]}))}(t,e);e.type===rt.AUTHORIZED&&n.isOriginator&&function(e){const{state:t}=e;t.authorized=!0,e.emit(nt.AUTHORIZED)}(t)}t.emit(nt.MESSAGE,e)}else!function(e,t){var n;const{state:o}=e;null===(n=o.communicationLayer)||void 0===n||n.sendMessage({type:rt.WALLET_INFO,walletInfo:o.walletInfo}),o.originatorInfo=t.originatorInfo||t.originator,e.emit(nt.CLIENTS_READY,{isOriginator:o.isOriginator,originatorInfo:o.originatorInfo}),o.paused=!1}(t,e)}function Tt(e,t){var n,o;return c(this,void 0,void 0,(function*(){const{state:i}=e;B.RemoteCommunication(`[RemoteCommunication: sendMessage()] context=${i.context} paused=${i.paused} ready=${i.ready} relayPersistence=${i.relayPersistence} authorized=${i.authorized} socket=${null===(n=i.communicationLayer)||void 0===n?void 0:n.isConnected()} clientsConnected=${i.clientsConnected} status=${i._connectionStatus}`,t),i.relayPersistence||i.ready&&(null===(o=i.communicationLayer)||void 0===o?void 0:o.isConnected())&&i.clientsConnected||(B.RemoteCommunication(`[RemoteCommunication: sendMessage()] context=${i.context}  SKIP message waiting for MM mobile readiness.`),yield new Promise((t=>{e.once(nt.CLIENTS_READY,t)})),B.RemoteCommunication(`[RemoteCommunication: sendMessage()] context=${i.context}  AFTER SKIP / READY -- sending pending message`));try{yield function(e,t){return c(this,void 0,void 0,(function*(){return new Promise((n=>{var o;const{state:i}=e;B.RemoteCommunication(`[RemoteCommunication: handleAuthorization()] context=${i.context} ready=${i.ready} authorized=${i.authorized} method=${t.method}`),!i.isOriginator||i.authorized||i.relayPersistence?(null===(o=i.communicationLayer)||void 0===o||o.sendMessage(t),n()):e.once(nt.AUTHORIZED,(()=>{var e;B.RemoteCommunication(`[RemoteCommunication: handleAuthorization()] context=${i.context}  AFTER SKIP / AUTHORIZED -- sending pending message`),null===(e=i.communicationLayer)||void 0===e||e.sendMessage(t),n()}))}))}))}(e,t)}catch(e){throw console.error(`[RemoteCommunication: sendMessage()] context=${i.context}  ERROR`,e),e}}))}function Nt(e){return t=>{let n=t;t.message&&(n=n.message),Rt(n,e)}}function Ot(e){return()=>{const{state:t}=e;B.RemoteCommunication("[RemoteCommunication: handleSocketReconnectEvent()] on 'socket_reconnect' -- reset key exchange status / set ready to false"),t.ready=!1,t.authorized=!1,et(t),e.emitServiceStatusEvent({context:"socket_reconnect"})}}function Pt(e){return()=>{const{state:t}=e;B.RemoteCommunication("[RemoteCommunication: handleSocketDisconnectedEvent()] on 'socket_Disconnected' set ready to false"),t.ready=!1}}function Lt(e){return()=>c(this,void 0,void 0,(function*(){var t,n,o,i,r,s,a;const{state:c}=e;B.RemoteCommunication(`[RemoteCommunication: handleFullPersistenceEvent()] context=${c.context}`),e.state.ready=!0,e.state.clientsConnected=!0,e.state.authorized=!0,e.state.relayPersistence=!0,null===(t=e.state.communicationLayer)||void 0===t||t.getKeyExchange().setKeysExchanged(!0),e.emit(nt.KEYS_EXCHANGED,{keysExchanged:!0,isOriginator:!0}),e.emit(nt.AUTHORIZED),e.emit(nt.CLIENTS_READY),e.emit(nt.CHANNEL_PERSISTENCE);try{c.channelConfig=Object.assign(Object.assign({},c.channelConfig),{localKey:null===(n=c.communicationLayer)||void 0===n?void 0:n.getKeyExchange().getKeyInfo().ecies.private,otherKey:null===(o=c.communicationLayer)||void 0===o?void 0:o.getKeyExchange().getOtherPublicKey(),channelId:null!==(i=c.channelId)&&void 0!==i?i:"",validUntil:null!==(s=null===(r=c.channelConfig)||void 0===r?void 0:r.validUntil)&&void 0!==s?s:Qe,relayPersistence:!0}),yield null===(a=c.storageManager)||void 0===a?void 0:a.persistChannelConfig(c.channelConfig)}catch(e){console.error("Error persisting channel config",e)}}))}function Dt({options:e,instance:t}){var n,o,i,r,a,c;const{state:l}=t;B.RemoteCommunication(`[RemoteCommunication: disconnect()] channel=${l.channelId}`,e),l.ready=!1,l.paused=!1,(null==e?void 0:e.terminate)?(null===(n=l.storageManager)||void 0===n||n.terminate(null!==(o=l.channelId)&&void 0!==o?o:""),t.state.terminated=!0,e.sendMessage&&(null===(i=l.communicationLayer)||void 0===i?void 0:i.getKeyInfo().keysExchanged)&&(null===(r=l.communicationLayer)||void 0===r||r.sendMessage({type:rt.TERMINATE})),l.authorized=!1,l.relayPersistence=!1,l.channelId=s(),e.channelId=l.channelId,l.channelConfig=void 0,l.originatorConnectStarted=!1,null===(a=l.communicationLayer)||void 0===a||a.disconnect(e),t.setConnectionStatus(tt.TERMINATED)):(null===(c=l.communicationLayer)||void 0===c||c.disconnect(e),t.setConnectionStatus(tt.DISCONNECTED))}!function(e){e.SOCKET="socket"}(St||(St={})),function(e){e.NonBrowser="nodejs",e.MetaMaskMobileWebview="in-app-browser",e.DesktopWeb="web-desktop",e.MobileWeb="web-mobile",e.ReactNative="react-native"}(kt||(kt={}));class $t extends i{constructor({platformType:e,communicationLayerPreference:t,otherPublicKey:n,reconnect:o,walletInfo:i,dappMetadata:r,protocolVersion:s,transports:a,context:c,relayPersistence:l,ecies:u,analytics:d=!1,storage:h,sdkVersion:g,communicationServerUrl:m=Ze,logging:f,autoConnect:y={timeout:3e3}}){super(),this.state={ready:!1,authorized:!1,isOriginator:!1,terminated:!1,protocolVersion:1,paused:!1,platformType:"metamask-mobile",analytics:!1,reconnection:!1,originatorInfoSent:!1,communicationServerUrl:Ze,context:"",persist:!1,clientsConnected:!1,sessionDuration:Qe,originatorConnectStarted:!1,debug:!1,_connectionStatus:tt.DISCONNECTED},this.state.otherPublicKey=n,this.state.dappMetadata=r,this.state.walletInfo=i,this.state.transports=a,this.state.platformType=e,this.state.analytics=d,this.state.protocolVersion=null!=s?s:1,this.state.isOriginator=!n,this.state.relayPersistence=l,this.state.communicationServerUrl=m,this.state.context=c,this.state.terminated=!1,this.state.sdkVersion=g,this.setMaxListeners(50),this.setConnectionStatus(tt.DISCONNECTED),(null==h?void 0:h.duration)&&(this.state.sessionDuration=Qe),this.state.storageOptions=h,this.state.autoConnectOptions=y,this.state.debug=!0===(null==f?void 0:f.remoteLayer),!0===(null==f?void 0:f.remoteLayer)&&U.enable("RemoteCommunication:Layer"),!0===(null==f?void 0:f.serviceLayer)&&U.enable("SocketService:Layer"),!0===(null==f?void 0:f.eciesLayer)&&U.enable("ECIES:Layer"),!0===(null==f?void 0:f.keyExchangeLayer)&&U.enable("KeyExchange:Layer"),this.state.logging=f,(null==h?void 0:h.storageManager)&&(this.state.storageManager=h.storageManager),B.RemoteCommunication(`[RemoteCommunication: constructor()] protocolVersion=${s} relayPersistence=${l} isOriginator=${this.state.isOriginator} communicationLayerPreference=${t} otherPublicKey=${n} reconnect=${o}`),this.initCommunicationLayer({communicationLayerPreference:t,otherPublicKey:n,reconnect:o,ecies:u,communicationServerUrl:m}),this.emitServiceStatusEvent({context:"constructor"})}initCommunicationLayer({communicationLayerPreference:e,otherPublicKey:t,reconnect:n,ecies:o,communicationServerUrl:i=Ze}){return function({communicationLayerPreference:e,otherPublicKey:t,reconnect:n,ecies:o,communicationServerUrl:i=Ze,instance:r}){var s,a,c,l,u,d,h,g,m,f,y;const{state:v}=r;if(B.RemoteCommunication("[initCommunicationLayer()] ",JSON.stringify(v,null,2)),e!==St.SOCKET)throw new Error("Invalid communication protocol");v.communicationLayer=new Ct({communicationLayerPreference:e,otherPublicKey:t,reconnect:n,transports:v.transports,communicationServerUrl:i,context:v.context,ecies:o,logging:v.logging,remote:r});let p="undefined"!=typeof document&&document.URL||"",E="undefined"!=typeof document&&document.title||"";(null===(s=v.dappMetadata)||void 0===s?void 0:s.url)&&(p=v.dappMetadata.url),(null===(a=v.dappMetadata)||void 0===a?void 0:a.name)&&(E=v.dappMetadata.name);const C=null!==(d=null!==(l=null===(c=v.dappMetadata)||void 0===c?void 0:c.name)&&void 0!==l?l:null===(u=v.dappMetadata)||void 0===u?void 0:u.url)&&void 0!==d?d:"N/A",S="undefined"!=typeof window&&void 0!==window.location&&null!==(h=window.location.hostname)&&void 0!==h?h:C,k={url:p,title:E,source:null===(g=v.dappMetadata)||void 0===g?void 0:g.source,dappId:S,icon:(null===(m=v.dappMetadata)||void 0===m?void 0:m.iconUrl)||(null===(f=v.dappMetadata)||void 0===f?void 0:f.base64Icon),platform:v.platformType,apiVersion:Je.version,connector:null===(y=v.dappMetadata)||void 0===y?void 0:y.connector};v.originatorInfo=k;const _={[nt.AUTHORIZED]:wt(r),[nt.MESSAGE]:Nt(r),[nt.CHANNEL_PERSISTENCE]:Lt(r),[nt.CLIENTS_CONNECTED]:xt(r,e),[nt.KEYS_EXCHANGED]:bt(r,e),[nt.SOCKET_DISCONNECTED]:Pt(r),[nt.SOCKET_RECONNECT]:Ot(r),[nt.CLIENTS_DISCONNECTED]:Kt(r,e),[nt.KEY_INFO]:()=>{},[nt.CHANNEL_CREATED]:It(r),[nt.CLIENTS_WAITING]:At(r),[nt.RPC_UPDATE]:e=>{r.emit(nt.RPC_UPDATE,e)}};for(const[e,t]of Object.entries(_))try{v.communicationLayer.on(e,t)}catch(t){console.error(`Error registering handler for ${e}:`,t)}}({communicationLayerPreference:e,otherPublicKey:t,reconnect:n,ecies:o,communicationServerUrl:i,instance:this})}initFromDappStorage(){return c(this,void 0,void 0,(function*(){if(this.state.storageManager){const e=yield this.state.storageManager.getPersistedChannelConfig({});e&&(this.state.channelConfig=e,this.state.channelId=e.channelId,e.relayPersistence&&(this.state.authorized=!0,this.state.ready=!0,this.setConnectionStatus(tt.LINKED),yield this.connectToChannel({channelId:e.channelId})))}}))}originatorSessionConnect(){return c(this,void 0,void 0,(function*(){return yield function(e){var t;return c(this,void 0,void 0,(function*(){const{state:n}=e;if(!n.storageManager)return void B.RemoteCommunication("[RemoteCommunication: originatorSessionConnect()] no storage manager defined - skip");const o=yield n.storageManager.getPersistedChannelConfig({});if(B.RemoteCommunication(`[RemoteCommunication: originatorSessionConnect()] autoStarted=${n.originatorConnectStarted} channelConfig`,o),null===(t=n.communicationLayer)||void 0===t?void 0:t.isConnected())return B.RemoteCommunication("[RemoteCommunication: originatorSessionConnect()] socket already connected - skip"),o;if(o){if(o.validUntil>Date.now())return n.channelConfig=o,n.originatorConnectStarted=!0,n.channelId=null==o?void 0:o.channelId,n.reconnection=!0,o;B.RemoteCommunication("[RemoteCommunication: autoConnect()] Session has expired")}n.originatorConnectStarted=!1}))}(this)}))}generateChannelIdConnect(){return c(this,void 0,void 0,(function*(){return function(e){var t,n,o,i,r,s;return c(this,void 0,void 0,(function*(){if(!e.communicationLayer)throw new Error("communication layer not initialized");if(e.ready)throw new Error("Channel already connected");if(e.channelId&&(null===(t=e.communicationLayer)||void 0===t?void 0:t.isConnected()))return e.channelConfig=Object.assign(Object.assign({},e.channelConfig),{channelId:e.channelId,validUntil:Date.now()+e.sessionDuration}),null===(n=e.storageManager)||void 0===n||n.persistChannelConfig(e.channelConfig),{channelId:e.channelId,privKey:null===(i=null===(o=e.communicationLayer)||void 0===o?void 0:o.getKeyInfo())||void 0===i?void 0:i.ecies.private,pubKey:null===(s=null===(r=e.communicationLayer)||void 0===r?void 0:r.getKeyInfo())||void 0===s?void 0:s.ecies.public};B.RemoteCommunication("[RemoteCommunication: generateChannelId()]");const a=yield e.communicationLayer.createChannel();B.RemoteCommunication("[RemoteCommunication: generateChannelId()] channel created",a);const c=Object.assign(Object.assign({},e.channelConfig),{channelId:a.channelId,localKey:a.privKey,validUntil:Date.now()+e.sessionDuration});return e.channelId=a.channelId,e.channelConfig=c,{channelId:e.channelId,pubKey:a.pubKey,privKey:a.privKey}}))}(this.state)}))}clean(){return et(this.state)}connectToChannel({channelId:e,withKeyExchange:t,authorized:n}){return function({channelId:e,withKeyExchange:t,authorized:n,state:o}){var i,s,a;return c(this,void 0,void 0,(function*(){if(!r(e))throw B.RemoteCommunication(`[RemoteCommunication: connectToChannel()] context=${o.context} invalid channel channelId=${e}`),new Error(`Invalid channel ${e}`);if(B.RemoteCommunication(`[RemoteCommunication: connectToChannel()] context=${o.context} channelId=${e} withKeyExchange=${t}`),null===(i=o.communicationLayer)||void 0===i?void 0:i.isConnected())return void B.RemoteCommunication(`[RemoteCommunication: connectToChannel()] context=${o.context} already connected - interrupt connection.`);o.channelId=e,yield null===(s=o.communicationLayer)||void 0===s?void 0:s.connectToChannel({channelId:e,authorized:n,withKeyExchange:t});const c=Object.assign(Object.assign({},o.channelConfig),{channelId:e,validUntil:Date.now()+o.sessionDuration});o.channelConfig=c,null===(a=o.storageManager)||void 0===a||a.persistChannelConfig(c)}))}({channelId:e,authorized:n,withKeyExchange:t,state:this.state})}sendMessage(e){return Tt(this,e)}testStorage(){return c(this,void 0,void 0,(function*(){return function(e){var t;return c(this,void 0,void 0,(function*(){const n=yield null===(t=e.storageManager)||void 0===t?void 0:t.getPersistedChannelConfig();B.RemoteCommunication("[RemoteCommunication: testStorage()] res",n)}))}(this.state)}))}getChannelConfig(){return this.state.channelConfig}isReady(){return this.state.ready}isConnected(){var e;return null===(e=this.state.communicationLayer)||void 0===e?void 0:e.isConnected()}isAuthorized(){return this.state.authorized}isPaused(){return this.state.paused}getCommunicationLayer(){return this.state.communicationLayer}ping(){var e;B.RemoteCommunication(`[RemoteCommunication: ping()] channel=${this.state.channelId}`),null===(e=this.state.communicationLayer)||void 0===e||e.ping()}testLogger(){B.RemoteCommunication(`testLogger() channel=${this.state.channelId}`),B.SocketService(`testLogger() channel=${this.state.channelId}`),B.Ecies(`testLogger() channel=${this.state.channelId}`),B.KeyExchange(`testLogger() channel=${this.state.channelId}`)}keyCheck(){var e;B.RemoteCommunication(`[RemoteCommunication: keyCheck()] channel=${this.state.channelId}`),null===(e=this.state.communicationLayer)||void 0===e||e.keyCheck()}setConnectionStatus(e){this.state._connectionStatus!==e&&(this.state._connectionStatus=e,this.emit(nt.CONNECTION_STATUS,e),this.emitServiceStatusEvent({context:"setConnectionStatus"}))}emitServiceStatusEvent(e={}){this.emit(nt.SERVICE_STATUS,this.getServiceStatus())}getConnectionStatus(){return this.state._connectionStatus}getServiceStatus(){return{originatorInfo:this.state.originatorInfo,keyInfo:this.getKeyInfo(),connectionStatus:this.state._connectionStatus,channelConfig:this.state.channelConfig,channelId:this.state.channelId}}getKeyInfo(){var e;return null===(e=this.state.communicationLayer)||void 0===e?void 0:e.getKeyInfo()}resetKeys(){var e;null===(e=this.state.communicationLayer)||void 0===e||e.resetKeys()}setOtherPublicKey(e){var t;const n=null===(t=this.state.communicationLayer)||void 0===t?void 0:t.getKeyExchange();if(!n)throw new Error("KeyExchange is not initialized.");n.getOtherPublicKey()!==e&&n.setOtherPublicKey(e)}pause(){var e;B.RemoteCommunication(`[RemoteCommunication: pause()] channel=${this.state.channelId}`),null===(e=this.state.communicationLayer)||void 0===e||e.pause(),this.setConnectionStatus(tt.PAUSED)}getVersion(){return Je.version}hasRelayPersistence(){var e;return null!==(e=this.state.relayPersistence)&&void 0!==e&&e}resume(){return function(e){var t;const{state:n}=e;B.RemoteCommunication(`[RemoteCommunication: resume()] channel=${n.channelId}`),null===(t=n.communicationLayer)||void 0===t||t.resume(),e.setConnectionStatus(tt.LINKED)}(this)}encrypt(e){var t,n,o;const i=null===(t=this.state.communicationLayer)||void 0===t?void 0:t.getKeyExchange(),r=null==i?void 0:i.getOtherPublicKey();if(!r)throw new Error("KeyExchange not completed");return null===(o=null===(n=this.state.communicationLayer)||void 0===n?void 0:n.state.eciesInstance)||void 0===o?void 0:o.encrypt(e,r)}decrypt(e){var t,n,o;if(!(null===(t=this.state.communicationLayer)||void 0===t?void 0:t.state.eciesInstance))throw new Error("ECIES instance is not initialized");return null===(o=null===(n=this.state.communicationLayer)||void 0===n?void 0:n.state.eciesInstance)||void 0===o?void 0:o.decrypt(e)}getChannelId(){return this.state.channelId}getRPCMethodTracker(){var e;return null===(e=this.state.communicationLayer)||void 0===e?void 0:e.getRPCMethodTracker()}disconnect(e){return Dt({options:e,instance:this})}}!function(e){e.RENEW="renew",e.LINK="link"}(_t||(_t={}));export{_t as AutoConnectType,St as CommunicationLayerPreference,tt as ConnectionStatus,Ze as DEFAULT_SERVER_URL,Qe as DEFAULT_SESSION_TIMEOUT_MS,We as ECIES,nt as EventType,it as KeyExchangeMessageType,rt as MessageType,kt as PlatformType,$t as RemoteCommunication,Z as SendAnalytics,Ct as SocketService,ht as TrackingEvents};
//# sourceMappingURL=metamask-sdk-communication-layer.js.map
